
[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/osama/Desktop/Invoice2E.1[39m

 [32mâœ“[39m lib/metrics.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 30[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/sanitizer.test.ts [2m([22m[2m20 tests[22m[2m)[22m[32m 270[2mms[22m[39m
[90mstdout[2m | .agent/skills/scripts/tests/validate_skills_headings.test.js
[22m[39mChecking YAML validity for 853 skills...
ok

[90mstdout[2m | tests/unit/pdf-splitter.service.test.ts[2m > [22m[2mPdfSplitterService[2m > [22m[2msplitByPageGroups[2m > [22m[2mshould split a 4-page PDF into 2 groups
[22m[39m{"timestamp":"2026-02-19T14:36:27.498Z","level":"INFO","message":"PDF split completed","data":{"sourcePages":4,"groups":2,"groupSizes":[2,2]}}

[90mstdout[2m | tests/unit/pdf-splitter.service.test.ts[2m > [22m[2mPdfSplitterService[2m > [22m[2msplitByPageGroups[2m > [22m[2mshould handle single-page groups
[22m[39m{"timestamp":"2026-02-19T14:36:27.523Z","level":"INFO","message":"PDF split completed","data":{"sourcePages":3,"groups":3,"groupSizes":[1,1,1]}}

[90mstdout[2m | tests/unit/pdf-splitter.service.test.ts[2m > [22m[2mPdfSplitterService[2m > [22m[2msplitByPageGroups[2m > [22m[2mshould handle uneven page groups
[22m[39m{"timestamp":"2026-02-19T14:36:27.532Z","level":"INFO","message":"PDF split completed","data":{"sourcePages":5,"groups":2,"groupSizes":[3,2]}}

 [32mâœ“[39m tests/unit/pdf-splitter.service.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 75[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/batch-worker.route.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 914[2mms[22m[39m
   [33m[2mâœ“[22m[39m Batch worker route (C-1 secret enforcement)[2m > [22mreturns 401 when BATCH_WORKER_SECRET is unset [33m 862[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/auth.signup.route.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 121[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2mextractInvoiceData[2m > [22m[2mshould perform two-step extraction (OCR + Chat)
[22m[39m{"timestamp":"2026-02-19T14:36:28.029Z","level":"INFO","message":"Mistral extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2mextractInvoiceData[2m > [22m[2mshould perform two-step extraction (OCR + Chat)
[22m[39m{"timestamp":"2026-02-19T14:36:28.037Z","level":"INFO","message":"Mistral extraction successful","data":{"processingTimeMs":8,"confidence":0.7}}

[90mstdout[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2msendPrompt[2m > [22m[2mshould use local text extraction then send prompt to chat
[22m[39m{"timestamp":"2026-02-19T14:36:28.138Z","level":"INFO","message":"sendPrompt using flat text extraction","data":{"source":"unpdf","textLength":23}}

 [32mâœ“[39m tests/unit/adapters/mistral.adapter.test.ts [2m([22m[2m9 tests[22m[2m)[22m[32m 115[2mms[22m[39m
[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould generate valid XML for complete invoice data
[22m[39m{"timestamp":"2026-02-19T14:36:29.010Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.028Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-001 Goods + Books: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.017Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-001"}}
{"timestamp":"2026-02-19T14:36:29.028Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-001","xmlSize":8666,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice number
[22m[39m{"timestamp":"2026-02-19T14:36:29.033Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":null}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-001 Goods + Books: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T14:36:29.034Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-001"}}
{"timestamp":"2026-02-19T14:36:29.035Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-001","xmlSize":8666,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-002 Software + Catering: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.038Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-002"}}
{"timestamp":"2026-02-19T14:36:29.039Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-002","xmlSize":8663,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice date
[22m[39m{"timestamp":"2026-02-19T14:36:29.041Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-002 Software + Catering: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T14:36:29.042Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-002"}}
{"timestamp":"2026-02-19T14:36:29.042Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-002","xmlSize":8663,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-003 Hardware + Shipping: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.044Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-003"}}
{"timestamp":"2026-02-19T14:36:29.044Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-003","xmlSize":10024,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject invalid total amount
[22m[39m{"timestamp":"2026-02-19T14:36:29.042Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-003 Hardware + Shipping: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T14:36:29.049Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-003"}}
{"timestamp":"2026-02-19T14:36:29.049Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-003","xmlSize":10024,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-004 3 items at 19% + 2 items at 7%: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.051Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-004"}}
{"timestamp":"2026-02-19T14:36:29.052Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-004","xmlSize":12750,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject empty line items
[22m[39m{"timestamp":"2026-02-19T14:36:29.042Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-004 3 items at 19% + 2 items at 7%: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T14:36:29.055Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-004"}}
{"timestamp":"2026-02-19T14:36:29.056Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-004","xmlSize":12750,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-005 Small amounts 7% + 19%: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.059Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-005"}}
{"timestamp":"2026-02-19T14:36:29.060Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-005","xmlSize":8622,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould escape XML special characters correctly
[22m[39m{"timestamp":"2026-02-19T14:36:29.043Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.043Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6889,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-005 Small amounts 7% + 19%: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T14:36:29.062Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-005"}}
{"timestamp":"2026-02-19T14:36:29.063Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-005","xmlSize":8622,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould format dates correctly (YYYYMMDD)
[22m[39m{"timestamp":"2026-02-19T14:36:29.048Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.049Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mB: Credit Notes (documentTypeCode 381)[2m > [22m[2mCN-001 Simple refund (19%): should generate valid XML with TypeCode 381
[22m[39m{"timestamp":"2026-02-19T14:36:29.066Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-CN-001"}}
{"timestamp":"2026-02-19T14:36:29.066Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-CN-001","xmlSize":7065,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould handle missing optional fields gracefully
[22m[39m{"timestamp":"2026-02-19T14:36:29.053Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.053Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6961,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mB: Credit Notes (documentTypeCode 381)[2m > [22m[2mCN-002 Multi-line refund (mixed rates): should generate valid XML with TypeCode 381
[22m[39m{"timestamp":"2026-02-19T14:36:29.067Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-CN-002"}}
{"timestamp":"2026-02-19T14:36:29.068Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-CN-002","xmlSize":8811,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould include tax breakdown calculations
[22m[39m{"timestamp":"2026-02-19T14:36:29.056Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.057Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mB: Credit Notes (documentTypeCode 381)[2m > [22m[2mCN-003 Partial refund (19%): should generate valid XML with TypeCode 381
[22m[39m{"timestamp":"2026-02-19T14:36:29.069Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-CN-003"}}
{"timestamp":"2026-02-19T14:36:29.070Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-CN-003","xmlSize":7073,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould map buyerElectronicAddress to XML URIUniversalCommunication with correct scheme
[22m[39m{"timestamp":"2026-02-19T14:36:29.061Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.062Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6863,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-001 Empty IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T14:36:29.074Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOIBAN-001"}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould use auto-detected scheme 0204 for non-email buyerElectronicAddress
[22m[39m{"timestamp":"2026-02-19T14:36:29.064Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.064Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6857,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mT5: should default to EM scheme for non-PEPPOL, non-email electronic address
[22m[39m{"timestamp":"2026-02-19T14:36:29.066Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.066Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6858,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-002 Null IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T14:36:29.076Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOIBAN-002"}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mT5: should use explicit scheme when provided (seller)
[22m[39m{"timestamp":"2026-02-19T14:36:29.068Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.068Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6858,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould use recomputed total (not raw totalAmount) for GrandTotalAmount (F1)
[22m[39m{"timestamp":"2026-02-19T14:36:29.069Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T14:36:29.070Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-003 Undefined IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T14:36:29.076Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOIBAN-003"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-001 No buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T14:36:29.077Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOENDPOINT-001"}}

 [32mâœ“[39m tests/unit/xrechnung.service.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 64[2mms[22m[39m
[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-002 Null buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T14:36:29.078Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOENDPOINT-002"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-003 No seller electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T14:36:29.079Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOENDPOINT-003"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.080Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T14:36:29.080Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should contain CategoryCode Z
[22m[39m{"timestamp":"2026-02-19T14:36:29.084Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T14:36:29.084Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should contain ExemptionReason for Z
[22m[39m{"timestamp":"2026-02-19T14:36:29.085Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T14:36:29.085Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T14:36:29.090Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T14:36:29.091Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T14:36:29.092Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T14:36:29.093Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.095Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T14:36:29.096Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain CategoryCode AE
[22m[39m{"timestamp":"2026-02-19T14:36:29.098Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T14:36:29.098Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain ExemptionReason for AE
[22m[39m{"timestamp":"2026-02-19T14:36:29.100Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T14:36:29.101Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T14:36:29.104Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T14:36:29.104Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T14:36:29.112Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T14:36:29.112Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain buyer VAT ID
[22m[39m{"timestamp":"2026-02-19T14:36:29.114Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T14:36:29.114Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.117Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T14:36:29.117Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain CategoryCode K
[22m[39m{"timestamp":"2026-02-19T14:36:29.124Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T14:36:29.125Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain ExemptionReason for K
[22m[39m{"timestamp":"2026-02-19T14:36:29.128Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T14:36:29.128Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T14:36:29.130Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T14:36:29.136Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T14:36:29.138Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T14:36:29.138Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain buyer VAT ID
[22m[39m{"timestamp":"2026-02-19T14:36:29.139Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T14:36:29.140Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.145Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T14:36:29.145Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should contain CategoryCode G
[22m[39m{"timestamp":"2026-02-19T14:36:29.149Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T14:36:29.149Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should contain ExemptionReason for G
[22m[39m{"timestamp":"2026-02-19T14:36:29.152Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T14:36:29.153Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T14:36:29.155Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T14:36:29.156Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T14:36:29.157Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T14:36:29.158Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.159Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T14:36:29.160Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should contain CategoryCode O
[22m[39m{"timestamp":"2026-02-19T14:36:29.170Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T14:36:29.170Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should contain ExemptionReason for O
[22m[39m{"timestamp":"2026-02-19T14:36:29.172Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T14:36:29.172Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T14:36:29.174Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T14:36:29.174Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T14:36:29.176Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T14:36:29.176Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T14:36:29.178Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T14:36:29.178Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should contain CategoryCode L
[22m[39m{"timestamp":"2026-02-19T14:36:29.180Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T14:36:29.181Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should contain ExemptionReason for L
[22m[39m{"timestamp":"2026-02-19T14:36:29.184Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T14:36:29.184Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T14:36:29.186Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T14:36:29.186Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T14:36:29.189Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T14:36:29.189Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mE: Edge cases[2m > [22m[2mZero-rate line item with taxCategoryCode E (exempt)
[22m[39m{"timestamp":"2026-02-19T14:36:29.193Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-EDGE-EXEMPT"}}
{"timestamp":"2026-02-19T14:36:29.193Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-EDGE-EXEMPT","xmlSize":6979,"warnings":0}}

 [32mâœ“[39m tests/unit/xrechnung-fixtures.test.ts [2m([22m[2m75 tests[22m[2m)[22m[32m 181[2mms[22m[39m
[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T14:36:35.310Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"e5081f22-ace0-41af-a118-cebae01b9579","invoiceId":"inv-001","stepCount":3}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T14:36:35.325Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"e5081f22-ace0-41af-a118-cebae01b9579","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T14:36:35.325Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"e5081f22-ace0-41af-a118-cebae01b9579","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T14:36:35.326Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"e5081f22-ace0-41af-a118-cebae01b9579","step":"extract"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T14:36:35.326Z","level":"INFO","message":"Saga execution completed","data":{"sagaId":"e5081f22-ace0-41af-a118-cebae01b9579","result":{"success":true,"completedSteps":["validate","deduct","extract"],"compensatedSteps":[]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T14:36:35.328Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"2cc639a2-94ae-4105-a32f-883ee542c2f2","invoiceId":"inv-001","stepCount":2}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T14:36:35.330Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"2cc639a2-94ae-4105-a32f-883ee542c2f2","step":"setExtraction"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T14:36:35.330Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"2cc639a2-94ae-4105-a32f-883ee542c2f2","step":"checkExtraction"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T14:36:35.330Z","level":"INFO","message":"Saga execution completed","data":{"sagaId":"2cc639a2-94ae-4105-a32f-883ee542c2f2","result":{"success":true,"completedSteps":["setExtraction","checkExtraction"],"compensatedSteps":[]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T14:36:35.333Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"5541177f-e16a-404d-9032-4761c820e1b0","invoiceId":"inv-001","stepCount":3}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T14:36:35.334Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"5541177f-e16a-404d-9032-4761c820e1b0","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T14:36:35.334Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"5541177f-e16a-404d-9032-4761c820e1b0","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T14:36:35.335Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"5541177f-e16a-404d-9032-4761c820e1b0","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T14:36:35.335Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"5541177f-e16a-404d-9032-4761c820e1b0","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T14:36:35.335Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"5541177f-e16a-404d-9032-4761c820e1b0","result":{"success":false,"completedSteps":["validate","deduct"],"failedStep":"extract","compensatedSteps":["deduct","validate"]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.336Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"cfed8f4b-7907-47fa-8cad-256b843c5626","invoiceId":"inv-001","stepCount":2}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.336Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"cfed8f4b-7907-47fa-8cad-256b843c5626","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.336Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"cfed8f4b-7907-47fa-8cad-256b843c5626","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.337Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"cfed8f4b-7907-47fa-8cad-256b843c5626","result":{"success":false,"completedSteps":["validate"],"failedStep":"failStep","compensatedSteps":["validate"]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould not compensate any steps when the first step fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.337Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"169fcf29-d0ad-46c7-a9e7-384b47e2c8c2","invoiceId":"inv-001","stepCount":2}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould not compensate any steps when the first step fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.337Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"169fcf29-d0ad-46c7-a9e7-384b47e2c8c2","result":{"success":false,"completedSteps":[],"failedStep":"validate","compensatedSteps":[]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.338Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"9ffe237b-8f14-49eb-b0c2-ae105f91922a","invoiceId":"inv-001","stepCount":4}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.338Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"9ffe237b-8f14-49eb-b0c2-ae105f91922a","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.338Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"9ffe237b-8f14-49eb-b0c2-ae105f91922a","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.339Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"9ffe237b-8f14-49eb-b0c2-ae105f91922a","step":"extract"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.339Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"9ffe237b-8f14-49eb-b0c2-ae105f91922a","step":"extract"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.340Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"9ffe237b-8f14-49eb-b0c2-ae105f91922a","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T14:36:35.340Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"9ffe237b-8f14-49eb-b0c2-ae105f91922a","result":{"success":false,"completedSteps":["validate","deduct","extract"],"failedStep":"convert","compensatedSteps":["extract","validate"]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T14:36:35.342Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"2ba89192-75c6-43b9-a1da-63f28c750f06","invoiceId":"inv-001","stepCount":2}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T14:36:35.344Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"2ba89192-75c6-43b9-a1da-63f28c750f06","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T14:36:35.344Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"2ba89192-75c6-43b9-a1da-63f28c750f06","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T14:36:35.344Z","level":"INFO","message":"Saga execution completed","data":{"sagaId":"2ba89192-75c6-43b9-a1da-63f28c750f06","result":{"success":true,"completedSteps":["validate","deduct"],"compensatedSteps":[]}}}

 [32mâœ“[39m lib/saga/orchestrator.test.ts [2m([22m[2m9 tests[22m[2m)[22m[32m 101[2mms[22m[39m
 [32mâœ“[39m tests/unit/external-validation.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 26[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/payments.checkout.route.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 31[2mms[22m[39m
[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mquarantine[2m > [22m[2mshould store file and create entry
[22m[39m{"timestamp":"2026-02-19T14:36:35.969Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"072f6a80-1d6b-4d99-9b32-98979746c2a8","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PDF file
[22m[39m{"timestamp":"2026-02-19T14:36:35.979Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"58fbe363-4c72-47e6-a137-0e23590d718f","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PDF file
[22m[39m{"timestamp":"2026-02-19T14:36:35.980Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"58fbe363-4c72-47e6-a137-0e23590d718f","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PNG file
[22m[39m{"timestamp":"2026-02-19T14:36:35.983Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"ed502290-8692-4781-8f49-b53f21e7f6e9","originalName":"receipt.png","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PNG file
[22m[39m{"timestamp":"2026-02-19T14:36:35.983Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"ed502290-8692-4781-8f49-b53f21e7f6e9","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid JPEG file
[22m[39m{"timestamp":"2026-02-19T14:36:35.985Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"2cf3dd5b-5401-4732-9e20-28d1921927c8","originalName":"photo.jpg","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid JPEG file
[22m[39m{"timestamp":"2026-02-19T14:36:35.985Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"2cf3dd5b-5401-4732-9e20-28d1921927c8","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with invalid extension
[22m[39m{"timestamp":"2026-02-19T14:36:35.986Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"922e368c-2b5d-4fef-83d8-4407da50935c","originalName":"malware.exe","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with invalid extension
[22m[39m{"timestamp":"2026-02-19T14:36:35.987Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"922e368c-2b5d-4fef-83d8-4407da50935c","isClean":false,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":false},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with magic bytes mismatch
[22m[39m{"timestamp":"2026-02-19T14:36:35.988Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"55dcf3aa-5cc8-4382-a4dd-71816b11ac19","originalName":"fake.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with magic bytes mismatch
[22m[39m{"timestamp":"2026-02-19T14:36:35.989Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"55dcf3aa-5cc8-4382-a4dd-71816b11ac19","isClean":false,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":false}]}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-cii[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:35.977Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject oversized file
[22m[39m{"timestamp":"2026-02-19T14:36:35.991Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"32316603-a9b7-4e2b-bf7a-76b4ef9150f1","originalName":"invoice.pdf","size":27262976}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject oversized file
[22m[39m{"timestamp":"2026-02-19T14:36:35.991Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"32316603-a9b7-4e2b-bf7a-76b4ef9150f1","isClean":false,"checks":[{"name":"file_size","passed":false},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with disallowed MIME type
[22m[39m{"timestamp":"2026-02-19T14:36:35.992Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"90aa1d0e-84c0-4fe2-a00c-22ea7d9f9ec7","originalName":"doc.html","size":1024}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:35.976Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with disallowed MIME type
[22m[39m{"timestamp":"2026-02-19T14:36:35.992Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"90aa1d0e-84c0-4fe2-a00c-22ea7d9f9ec7","isClean":false,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":false},{"name":"mime_type_allowlist","passed":false},{"name":"magic_bytes","passed":false}]}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mgenerates PDF output with pdfContent buffer
[22m[39m{"timestamp":"2026-02-19T14:36:35.979Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould throw when scanning non-quarantined entry
[22m[39m{"timestamp":"2026-02-19T14:36:35.993Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"95963a77-cf6a-475c-b6d9-9157f533738c","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould throw when scanning non-quarantined entry
[22m[39m{"timestamp":"2026-02-19T14:36:35.993Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"95963a77-cf6a-475c-b6d9-9157f533738c","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-cii[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:35.994Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould promote a clean file
[22m[39m{"timestamp":"2026-02-19T14:36:35.994Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"333ff9f8-894a-4531-90f5-85af115d7c3c","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould promote a clean file
[22m[39m{"timestamp":"2026-02-19T14:36:35.994Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"333ff9f8-894a-4531-90f5-85af115d7c3c","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould promote a clean file
[22m[39m{"timestamp":"2026-02-19T14:36:35.994Z","level":"INFO","message":"File promoted to production","data":{"quarantineId":"333ff9f8-894a-4531-90f5-85af115d7c3c","productionPath":"/production/333ff9f8-894a-4531-90f5-85af115d7c3c/invoice.pdf"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould throw when promoting non-clean file
[22m[39m{"timestamp":"2026-02-19T14:36:35.995Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"a573f3ee-d3ea-4c91-9952-743599afd6b6","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould reject a quarantined file with reason
[22m[39m{"timestamp":"2026-02-19T14:36:35.996Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"6c8a4bc3-cde8-42de-8718-2a6c259788d2","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould reject a quarantined file with reason
[22m[39m{"timestamp":"2026-02-19T14:36:35.998Z","level":"INFO","message":"File rejected","data":{"quarantineId":"6c8a4bc3-cde8-42de-8718-2a6c259788d2","reason":"Manual review: suspicious content"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-ubl[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:35.996Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T14:36:35.997Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:35.999Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:35.996Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T14:36:35.997Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T14:36:35.999Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:35.999Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T14:36:36.000Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T14:36:36.000Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-ubl[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.000Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T14:36:36.000Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.000Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: peppol-bis[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:36.001Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T14:36:36.001Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.001Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: peppol-bis[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.002Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T14:36:36.002Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.002Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:36.000Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T14:36:36.000Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CONSIST-2024-007"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw when rejecting promoted file
[22m[39m{"timestamp":"2026-02-19T14:36:36.004Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"879cf207-6a99-43f8-bf9e-e6b5717e82a5","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw when rejecting promoted file
[22m[39m{"timestamp":"2026-02-19T14:36:36.008Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"879cf207-6a99-43f8-bf9e-e6b5717e82a5","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw when rejecting promoted file
[22m[39m{"timestamp":"2026-02-19T14:36:36.008Z","level":"INFO","message":"File promoted to production","data":{"quarantineId":"879cf207-6a99-43f8-bf9e-e6b5717e82a5","productionPath":"/production/879cf207-6a99-43f8-bf9e-e6b5717e82a5/invoice.pdf"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-en16931[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:36.003Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T14:36:36.003Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw on empty reason
[22m[39m{"timestamp":"2026-02-19T14:36:36.009Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"9913f9c6-58c4-4822-95c0-3d56f05606d5","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mcleanup[2m > [22m[2mshould clean expired entries
[22m[39m{"timestamp":"2026-02-19T14:36:36.011Z","level":"INFO","message":"Quarantine cleanup completed","data":{"cleaned":1,"total":1}}

 [32mâœ“[39m lib/file-quarantine.test.ts [2m([22m[2m17 tests[22m[2m)[22m[32m 48[2mms[22m[39m
[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: xrechnung-cii[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:35.983Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mxrechnung-cii â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:35.979Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.029Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T14:36:36.030Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T14:36:36.032Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.033Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T14:36:36.034Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T14:36:36.035Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.036Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T14:36:36.036Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-ZEROTAX-001"}}

 [32mâœ“[39m tests/unit/utils.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 175[2mms[22m[39m
[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: xrechnung-ubl[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.037Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T14:36:36.038Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.101Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: peppol-bis[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.103Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T14:36:36.104Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.104Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: facturx-en16931[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.106Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T14:36:36.106Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"GOLDEN-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mgenerates valid PDF that pdf-lib can parse
[22m[39m{"timestamp":"2026-02-19T14:36:36.195Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/ksef.test.ts[2m > [22m[2mKSeF Factory Integration[2m > [22m[2mshould create ksef generator via factory
[22m[39m{"timestamp":"2026-02-19T14:36:36.266Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

 [32mâœ“[39m tests/unit/ksef.test.ts [2m([22m[2m39 tests[22m[2m)[22m[32m 26[2mms[22m[39m
[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:36.312Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T14:36:36.312Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CONSIST-2024-007"}}

[90mstdout[2m | lib/feature-flags/feature-flags.test.ts[2m > [22m[2mFeatureFlagService[2m > [22m[2msetFlag[2m > [22m[2mupdates flag and invalidates cache
[22m[39m{"timestamp":"2026-02-19T14:36:36.337Z","level":"INFO","message":"Feature flag updated","data":{"flagId":"toggle","enabled":false}}

 [32mâœ“[39m lib/gdpr/gdpr.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 51[2mms[22m[39m
[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould generate XML with NLCIUS customization ID
[22m[39m{"timestamp":"2026-02-19T14:36:36.371Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.378Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould NOT contain PEPPOL customization ID
[22m[39m{"timestamp":"2026-02-19T14:36:36.379Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.379Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould generate valid UBL XML structure
[22m[39m{"timestamp":"2026-02-19T14:36:36.380Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.380Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould produce _nlcius file name
[22m[39m{"timestamp":"2026-02-19T14:36:36.381Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.382Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould set fileSize correctly
[22m[39m{"timestamp":"2026-02-19T14:36:36.383Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.383Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Additional Coverage[2m > [22m[2mhandles credit note (documentTypeCode 381)
[22m[39m{"timestamp":"2026-02-19T14:36:36.388Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.388Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Additional Coverage[2m > [22m[2mhandles non-EUR currency (USD)
[22m[39m{"timestamp":"2026-02-19T14:36:36.389Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.389Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Additional Coverage[2m > [22m[2mhandles missing endpoint IDs without crashing
[22m[39m{"timestamp":"2026-02-19T14:36:36.389Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.390Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Factory Registration[2m > [22m[2mshould be available via GeneratorFactory
[22m[39m{"timestamp":"2026-02-19T14:36:36.401Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}

 [32mâœ“[39m tests/unit/nlcius.test.ts [2m([22m[2m20 tests[22m[2m)[22m[32m 39[2mms[22m[39m
 [32mâœ“[39m lib/feature-flags/feature-flags.test.ts [2m([22m[2m20 tests[22m[2m)[22m[32m 97[2mms[22m[39m
[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: facturx-basic[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.379Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T14:36:36.379Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"GOLDEN-2024-001"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:36.451Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:36.453Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:36.455Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T14:36:36.455Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T14:36:36.455Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T14:36:36.460Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T14:36:36.460Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T14:36:36.460Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mPDF filename ends with _facturx.pdf
[22m[39m{"timestamp":"2026-02-19T14:36:36.427Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.479Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T14:36:36.480Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-ZEROTAX-001"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: fatturapa[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.522Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: ksef[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.525Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: nlcius[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.527Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T14:36:36.527Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.528Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: cius-ro[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T14:36:36.531Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T14:36:36.531Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.531Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-en16931[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.531Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T14:36:36.531Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CROSS-2024-001"}}

 [32mâœ“[39m tests/unit/golden-files.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 559[2mms[22m[39m
[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency[2m > [22m[2mFactur-X formats embed XML in PDF
[22m[39m{"timestamp":"2026-02-19T14:36:36.593Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CONSIST-2024-007"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-basic[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:36.622Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T14:36:36.622Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mfileSize matches pdfContent length
[22m[39m{"timestamp":"2026-02-19T14:36:36.652Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency[2m > [22m[2mFactur-X formats embed XML in PDF
[22m[39m{"timestamp":"2026-02-19T14:36:36.701Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CONSIST-2024-007"}}

 [32mâœ“[39m tests/unit/cross-format-consistency.test.ts [2m([22m[2m56 tests[22m[2m)[22m[33m 736[2mms[22m[39m
[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mfatturapa â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.718Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mksef â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.720Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.722Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T14:36:36.722Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T14:36:36.723Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.741Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T14:36:36.741Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T14:36:36.742Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.749Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T14:36:36.749Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.750Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T14:36:36.750Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.750Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-CN-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.759Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-CN-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.773Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T14:36:36.773Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.774Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T14:36:36.774Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.779Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T14:36:36.779Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-basic[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.779Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T14:36:36.780Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.780Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T14:36:36.780Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.781Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-MULTITAX-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: fatturapa[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:36.792Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: fatturapa[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.795Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: ksef[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:36.795Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: ksef[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.797Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: nlcius[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:36.798Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T14:36:36.798Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.798Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: nlcius[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.799Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T14:36:36.799Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.799Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2malso produces xmlContent with CII XML
[22m[39m{"timestamp":"2026-02-19T14:36:36.813Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2membedded XML has correct Factur-X EN16931 SpecificationID
[22m[39m{"timestamp":"2026-02-19T14:36:36.823Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2membedded XML has correct Factur-X BASIC SpecificationID
[22m[39m{"timestamp":"2026-02-19T14:36:36.831Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: cius-ro[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T14:36:36.854Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T14:36:36.854Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.854Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: cius-ro[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T14:36:36.855Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T14:36:36.855Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T14:36:36.855Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.856Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-MULTITAX-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mFactur-X formats return pdfContent (Buffer)
[22m[39m{"timestamp":"2026-02-19T14:36:36.858Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T14:36:36.858Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mdoes NOT contain XRechnung SpecificationID
[22m[39m{"timestamp":"2026-02-19T14:36:36.896Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mFactur-X formats return pdfContent (Buffer)
[22m[39m{"timestamp":"2026-02-19T14:36:36.920Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T14:36:36.920Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.929Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T14:36:36.929Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.930Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T14:36:36.931Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.939Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T14:36:36.939Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.940Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T14:36:36.940Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:36.941Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-ALLOWANCE-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mincludes standard invoice fields in XML
[22m[39m{"timestamp":"2026-02-19T14:36:36.952Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat switching: generate same invoice in format A then format B
[22m[39m{"timestamp":"2026-02-19T14:36:36.974Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}
{"timestamp":"2026-02-19T14:36:36.974Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

 [32mâœ“[39m tests/unit/cross-format.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 1004[2mms[22m[39m
   [33m[2mâœ“[22m[39m Cross-Format Integration[2m > [22mformat: facturx-en16931[2m > [22mgenerates without throwing [33m 527[2mms[22m[39m
[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mincludes seller and buyer info in XML
[22m[39m{"timestamp":"2026-02-19T14:36:37.100Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.098Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-ALLOWANCE-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles credit notes (TypeCode 381)
[22m[39m{"timestamp":"2026-02-19T14:36:37.170Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles non-EUR currency (USD)
[22m[39m{"timestamp":"2026-02-19T14:36:37.178Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles GBP currency
[22m[39m{"timestamp":"2026-02-19T14:36:37.185Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles allowances/charges
[22m[39m{"timestamp":"2026-02-19T14:36:37.194Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mvisual PDF has at least one page
[22m[39m{"timestamp":"2026-02-19T14:36:37.208Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.231Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T14:36:37.231Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.233Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T14:36:37.233Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.247Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T14:36:37.247Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.248Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T14:36:37.248Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.249Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-MIN-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.286Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-MIN-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mvalidate()[2m > [22m[2mpasses for valid Factur-X XML
[22m[39m{"timestamp":"2026-02-19T14:36:37.398Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.445Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T14:36:37.445Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.446Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T14:36:37.446Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.452Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T14:36:37.453Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.454Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T14:36:37.454Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.456Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-MAX-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFactur-X factory registration[2m > [22m[2mGeneratorFactory.create("facturx-en16931") returns FacturXGenerator
[22m[39m{"timestamp":"2026-02-19T14:36:37.478Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFactur-X factory registration[2m > [22m[2mGeneratorFactory.create("facturx-basic") returns FacturXGenerator
[22m[39m{"timestamp":"2026-02-19T14:36:37.479Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFactur-X factory registration[2m > [22m[2mreturns cached singleton for facturx-en16931
[22m[39m{"timestamp":"2026-02-19T14:36:37.480Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.464Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-MAX-001"}}

 [32mâœ“[39m tests/unit/facturx.test.ts [2m([22m[2m38 tests[22m[2m)[22m[33m 1506[2mms[22m[39m
[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.617Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T14:36:37.617Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.618Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T14:36:37.618Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mxrechnung-ubl â€” rejects or handles gracefully
[22m[39m{"timestamp":"2026-02-19T14:36:37.624Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T14:36:37.624Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.624Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T14:36:37.624Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.625Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-GBP-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.631Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-GBP-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.640Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T14:36:37.640Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.640Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T14:36:37.640Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.646Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T14:36:37.646Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.647Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T14:36:37.647Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.647Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-LONG-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.653Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-LONG-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.690Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T14:36:37.690Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.691Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T14:36:37.695Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.699Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.699Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.700Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.700Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.700Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.708Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.728Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.728Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T14:36:37.800Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.800Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mxrechnung-ubl â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T14:36:37.912Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.912Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mpeppol-bis â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T14:36:37.914Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.914Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mfacturx-en16931 â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T14:36:37.920Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mfacturx-basic â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T14:36:37.925Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mnlcius â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T14:36:37.930Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.930Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mcius-ro â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T14:36:37.930Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T14:36:37.931Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

 [32mâœ“[39m tests/unit/edge-cases.test.ts [2m([22m[2m90 tests[22m[2m)[22m[33m 1955[2mms[22m[39m
   [33m[2mâœ“[22m[39m Edge Cases[2m > [22mzero-tax (exempt)[2m > [22mfacturx-en16931 â€” generates valid output [33m 410[2mms[22m[39m
 [32mâœ“[39m lib/container/container.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 40[2mms[22m[39m
[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mcreateApiKey[2m > [22m[2mshould create a key and return it once
[22m[39m{"timestamp":"2026-02-19T14:36:41.621Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"e4f648b5-a9fc-48fd-87ea-7d45995534d7"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mvalidateApiKey[2m > [22m[2mshould validate a correctly created key
[22m[39m{"timestamp":"2026-02-19T14:36:41.635Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"86996e46-d807-47f0-aaa1-fd82c16e6acc"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mvalidateApiKey[2m > [22m[2mshould reject expired key
[22m[39m{"timestamp":"2026-02-19T14:36:41.636Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"26f6b7da-9f9a-43c1-9b73-af3d3de9d154"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mvalidateApiKey[2m > [22m[2mshould reject expired key
[22m[39m{"timestamp":"2026-02-19T14:36:41.636Z","level":"INFO","message":"API key expired","data":{"keyId":"26f6b7da-9f9a-43c1-9b73-af3d3de9d154"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrevokeKey[2m > [22m[2mshould revoke an existing key
[22m[39m{"timestamp":"2026-02-19T14:36:41.636Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"c9a3ec8a-0499-4c29-a214-3d4da7e502ae"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrevokeKey[2m > [22m[2mshould revoke an existing key
[22m[39m{"timestamp":"2026-02-19T14:36:41.637Z","level":"INFO","message":"API key revoked","data":{"keyId":"c9a3ec8a-0499-4c29-a214-3d4da7e502ae","userId":"550e8400-e29b-41d4-a716-446655440000"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mlistKeys[2m > [22m[2mshould list keys without exposing raw keys
[22m[39m{"timestamp":"2026-02-19T14:36:41.637Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"2093bca5-d0b9-4482-bfde-95c51f4548a5"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mlistKeys[2m > [22m[2mshould list keys without exposing raw keys
[22m[39m{"timestamp":"2026-02-19T14:36:41.638Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"c62a0c21-e053-4e5d-a616-ec8f72a8c264"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrotateKey[2m > [22m[2mshould revoke old key and create new one with same scopes
[22m[39m{"timestamp":"2026-02-19T14:36:41.639Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"4ad1c674-dae9-4cfc-a68e-395191d0c027"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrotateKey[2m > [22m[2mshould revoke old key and create new one with same scopes
[22m[39m{"timestamp":"2026-02-19T14:36:41.639Z","level":"INFO","message":"API key revoked","data":{"keyId":"4ad1c674-dae9-4cfc-a68e-395191d0c027","userId":"550e8400-e29b-41d4-a716-446655440000"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrotateKey[2m > [22m[2mshould revoke old key and create new one with same scopes
[22m[39m{"timestamp":"2026-02-19T14:36:41.639Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"c612e489-21fd-4541-91a0-61b263ffd8f0"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mscope checking[2m > [22m[2mshould correctly validate scopes on created key
[22m[39m{"timestamp":"2026-02-19T14:36:41.640Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"b5becd55-c045-4d6e-a16b-0c4e9503f58d"}}

 [32mâœ“[39m lib/api-keys/api-keys.test.ts [2m([22m[2m23 tests[22m[2m)[22m[32m 33[2mms[22m[39m
 [32mâœ“[39m lib/rbac/rbac.test.ts [2m([22m[2m26 tests[22m[2m)[22m[32m 21[2mms[22m[39m
[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mgenerates valid UBL 2.1 XML
[22m[39m{"timestamp":"2026-02-19T14:36:42.087Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.098Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhas correct PEPPOL CustomizationID
[22m[39m{"timestamp":"2026-02-19T14:36:42.099Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.099Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mdoes NOT contain XRechnung CustomizationID
[22m[39m{"timestamp":"2026-02-19T14:36:42.100Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.100Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhas correct ProfileID
[22m[39m{"timestamp":"2026-02-19T14:36:42.100Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.100Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mdoes NOT include Leitweg-ID
[22m[39m{"timestamp":"2026-02-19T14:36:42.101Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.101Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles non-EUR currency (SEK)
[22m[39m{"timestamp":"2026-02-19T14:36:42.102Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.102Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles GBP currency
[22m[39m{"timestamp":"2026-02-19T14:36:42.102Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.102Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles NOK currency
[22m[39m{"timestamp":"2026-02-19T14:36:42.103Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.103Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles DKK currency
[22m[39m{"timestamp":"2026-02-19T14:36:42.103Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.103Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mincludes EndpointID elements
[22m[39m{"timestamp":"2026-02-19T14:36:42.104Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.104Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mincludes required elements: InvoiceNumber, IssueDate, Currency
[22m[39m{"timestamp":"2026-02-19T14:36:42.104Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.105Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mincludes line items
[22m[39m{"timestamp":"2026-02-19T14:36:42.105Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.105Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mgenerates credit notes (TypeCode 381) correctly
[22m[39m{"timestamp":"2026-02-19T14:36:42.105Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.106Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mgenerates correct filename with _peppol suffix
[22m[39m{"timestamp":"2026-02-19T14:36:42.106Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.106Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mreports correct file size
[22m[39m{"timestamp":"2026-02-19T14:36:42.106Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.106Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles allowances/charges
[22m[39m{"timestamp":"2026-02-19T14:36:42.107Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.107Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mvalidate()[2m > [22m[2mpasses for valid PEPPOL XML
[22m[39m{"timestamp":"2026-02-19T14:36:42.107Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T14:36:42.107Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPEPPOL BIS factory registration[2m > [22m[2mGeneratorFactory.create("peppol-bis") returns PeppolBISGenerator
[22m[39m{"timestamp":"2026-02-19T14:36:42.114Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPEPPOL BIS factory registration[2m > [22m[2mreturns cached singleton for peppol-bis
[22m[39m{"timestamp":"2026-02-19T14:36:42.115Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}

 [32mâœ“[39m tests/unit/peppol-bis.test.ts [2m([22m[2m35 tests[22m[2m)[22m[32m 32[2mms[22m[39m
 [32mâœ“[39m tests/unit/ai-sanitization.test.ts [2m([22m[2m40 tests[22m[2m)[22m[32m 27[2mms[22m[39m
 [32mâœ“[39m tests/unit/adapters/supabase.adapter.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 29[2mms[22m[39m
 [32mâœ“[39m tests/unit/file.service.test.ts [2m([22m[2m22 tests[22m[2m)[22m[32m 22[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T14:36:43.467Z","level":"INFO","message":"OpenAI extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T14:36:43.473Z","level":"INFO","message":"OpenAI extraction successful","data":{"processingTimeMs":6,"confidence":0.7}}

[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle API timeouts
[22m[39m{"timestamp":"2026-02-19T14:36:43.476Z","level":"INFO","message":"OpenAI extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T14:36:43.479Z","level":"INFO","message":"OpenAI extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

 [32mâœ“[39m tests/unit/adapters/openai.adapter.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 17[2mms[22m[39m
[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: xrechnung-cii
[22m[39m{"timestamp":"2026-02-19T14:36:43.588Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: xrechnung-ubl
[22m[39m{"timestamp":"2026-02-19T14:36:43.604Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T14:36:43.606Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RT-2024-042"}}
{"timestamp":"2026-02-19T14:36:43.607Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: peppol-bis
[22m[39m{"timestamp":"2026-02-19T14:36:43.609Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T14:36:43.609Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RT-2024-042"}}
{"timestamp":"2026-02-19T14:36:43.609Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: fatturapa
[22m[39m{"timestamp":"2026-02-19T14:36:43.611Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: ksef
[22m[39m{"timestamp":"2026-02-19T14:36:43.614Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

 [32mâœ“[39m tests/unit/round-trip.test.ts [2m([22m[2m35 tests[22m[2m)[22m[32m 29[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/auth.logout.route.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 36[2mms[22m[39m
 [32mâœ“[39m lib/retention/retention.test.ts [2m([22m[2m26 tests[22m[2m)[22m[32m 31[2mms[22m[39m
 [32mâœ“[39m tests/unit/xml-utils.test.ts [2m([22m[2m24 tests[22m[2m)[22m[32m 18[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/stripe.adapter.test.ts[2m > [22m[2mStripeAdapter[2m > [22m[2mshould construct webhook event verification
[22m[39m{"timestamp":"2026-02-19T14:36:43.996Z","level":"INFO","message":"Stripe webhook signature verified successfully"}

[90mstdout[2m | tests/unit/adapters/stripe.adapter.test.ts[2m > [22m[2mStripeAdapter[2m > [22m[2mshould refund payment
[22m[39m{"timestamp":"2026-02-19T14:36:44.003Z","level":"INFO","message":"Stripe refund successful","data":{"refundId":"re_123","paymentIntentId":"pi_123","amount":1000,"status":"succeeded"}}

 [32mâœ“[39m tests/unit/adapters/stripe.adapter.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 23[2mms[22m[39m
 [32mâœ“[39m lib/state-machine/invoice-machine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[32m 22[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/admin.user.detail.route.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 24[2mms[22m[39m
[90mstdout[2m | tests/unit/fatturapa.test.ts[2m > [22m[2mFatturaPA Factory Integration[2m > [22m[2mGeneratorFactory.create("fatturapa") works
[22m[39m{"timestamp":"2026-02-19T14:36:45.584Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

 [32mâœ“[39m tests/unit/fatturapa.test.ts [2m([22m[2m34 tests[22m[2m)[22m[32m 25[2mms[22m[39m
 [32mâœ“[39m lib/xml-security.test.ts [2m([22m[2m28 tests[22m[2m)[22m[32m 19[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/packages.route.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 15[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/auth.me.route.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 24[2mms[22m[39m
[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUSROGenerator[2m > [22m[2mshould generate XML with CIUS-RO customization ID
[22m[39m{"timestamp":"2026-02-19T14:36:49.339Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T14:36:49.346Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUSROGenerator[2m > [22m[2mshould NOT contain PEPPOL customization ID
[22m[39m{"timestamp":"2026-02-19T14:36:49.347Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T14:36:49.348Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUSROGenerator[2m > [22m[2mshould produce _ciusro file name
[22m[39m{"timestamp":"2026-02-19T14:36:49.348Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T14:36:49.348Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Additional Coverage[2m > [22m[2mhandles credit note (documentTypeCode 381)
[22m[39m{"timestamp":"2026-02-19T14:36:49.353Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T14:36:49.353Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Additional Coverage[2m > [22m[2mhandles non-RON currency (EUR)
[22m[39m{"timestamp":"2026-02-19T14:36:49.354Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T14:36:49.354Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Additional Coverage[2m > [22m[2mhandles missing endpoint IDs without crashing
[22m[39m{"timestamp":"2026-02-19T14:36:49.355Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T14:36:49.355Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Factory Registration[2m > [22m[2mshould be available via GeneratorFactory
[22m[39m{"timestamp":"2026-02-19T14:36:49.355Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}

 [32mâœ“[39m tests/unit/ciusro.test.ts [2m([22m[2m17 tests[22m[2m)[22m[32m 21[2mms[22m[39m
 [32mâœ“[39m tests/unit/review.service.test.ts [2m([22m[2m38 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m tests/unit/adapters/sendgrid.adapter.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 26[2mms[22m[39m
 [32mâœ“[39m tests/unit/validation-pipeline.test.ts [2m([22m[2m24 tests[22m[2m)[22m[32m 13[2mms[22m[39m
[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mGenerated XML â€” canonical identifiers[2m > [22m[2mcontains the PEPPOL BIS 3.0 CustomizationID
[22m[39m{"timestamp":"2026-02-19T14:36:49.569Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"TEST-PEPPOL-3020"}}
{"timestamp":"2026-02-19T14:36:49.586Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mGenerated XML â€” canonical identifiers[2m > [22m[2mcontains the PEPPOL BIS 3.0 ProfileID
[22m[39m{"timestamp":"2026-02-19T14:36:49.587Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"TEST-PEPPOL-3020"}}
{"timestamp":"2026-02-19T14:36:49.588Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mGenerated XML â€” canonical identifiers[2m > [22m[2mcontains EndpointID for seller (BT-34)
[22m[39m{"timestamp":"2026-02-19T14:36:49.588Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"TEST-PEPPOL-3020"}}
{"timestamp":"2026-02-19T14:36:49.588Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mxrechnung-cii has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.593Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mxrechnung-ubl has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.594Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mpeppol-bis has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.594Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mfacturx-en16931 has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.594Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mfacturx-basic has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.595Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mfatturapa has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.595Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mksef has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.595Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mnlcius has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.596Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mcius-ro has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T14:36:49.596Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}

 [32mâœ“[39m tests/unit/peppol-v3020.test.ts [2m([22m[2m23 tests[22m[2m)[22m[32m 32[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T14:36:49.684Z","level":"INFO","message":"Gemini extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T14:36:49.690Z","level":"INFO","message":"Gemini extraction successful","data":{"processingTimeMs":6,"confidence":0.7}}

[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T14:36:49.692Z","level":"INFO","message":"Gemini extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T14:36:49.694Z","level":"INFO","message":"Gemini extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

 [32mâœ“[39m tests/unit/adapters/gemini.adapter.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m lib/outbox/outbox.test.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 16[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/api-throttle.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 11[2mms[22m[39m
 [32mâœ“[39m lib/encryption/envelope.test.ts [2m([22m[2m17 tests[22m[2m)[22m[32m 14[2mms[22m[39m
[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mprocessPayment throws for invalid package
[22m[39m{"timestamp":"2026-02-19T14:36:51.665Z","level":"INFO","message":"Processing payment","data":{"method":"stripe","userId":"user-1","packageId":"invalid_pkg"}}

[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mprocessPayment creates stripe session when configured
[22m[39m{"timestamp":"2026-02-19T14:36:51.680Z","level":"INFO","message":"Processing payment","data":{"method":"stripe","userId":"user-1","packageId":"basic_10"}}

[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mhandleStripeWebhook returns already processed when event exists
[22m[39m{"timestamp":"2026-02-19T14:36:51.683Z","level":"INFO","message":"Handling Stripe webhook","data":{"type":"checkout.session.completed","eventId":"evt_1"}}

[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mhandleStripeWebhook returns already processed when event exists
[22m[39m{"timestamp":"2026-02-19T14:36:51.683Z","level":"INFO","message":"Webhook already processed, skipping","data":{"eventId":"evt_1"}}

 [32mâœ“[39m tests/unit/payment-processor.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 23[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/health.route.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m tests/unit/ai/extractors.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 13[2mms[22m[39m
 [32mâœ“[39m tests/unit/auth.service.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 13[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/handleApiError.test.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 15[2mms[22m[39m
 [32mâœ“[39m lib/circuit-breaker.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 9[2mms[22m[39m
[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mcreates xrechnung-cii generator
[22m[39m{"timestamp":"2026-02-19T14:36:55.739Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mcreates xrechnung-ubl generator
[22m[39m{"timestamp":"2026-02-19T14:36:55.745Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mreturns cached singleton instances
[22m[39m{"timestamp":"2026-02-19T14:36:55.746Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mreturns different instances for different formats
[22m[39m{"timestamp":"2026-02-19T14:36:55.746Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}
{"timestamp":"2026-02-19T14:36:55.746Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mcreates fatturapa generator
[22m[39m{"timestamp":"2026-02-19T14:36:55.748Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mclear resets the cache
[22m[39m{"timestamp":"2026-02-19T14:36:55.750Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}
{"timestamp":"2026-02-19T14:36:55.750Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

 [32mâœ“[39m tests/unit/GeneratorFactory.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 14[2mms[22m[39m
 [32mâœ“[39m tests/unit/readiness-panel-logic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 13[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/utils.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m tests/unit/boundary-detection.service.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 11[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/extraction-normalizer-taxrate-array.test.ts[2m > [22m[2mextraction-normalizer: taxRate array handling[2m > [22m[2mshould convert line item taxRate array to undefined
[22m[39m{"timestamp":"2026-02-19T14:36:56.893Z","level":"INFO","message":"Gross pricing detected â€” converting line items and allowances to NET","data":{"lineTotal":100,"totalAmount":100,"taxAmount":100}}

[90mstdout[2m | tests/unit/lib/extraction-normalizer-taxrate-array.test.ts[2m > [22m[2mextraction-normalizer: taxRate array handling[2m > [22m[2mshould preserve normal line item taxRate
[22m[39m{"timestamp":"2026-02-19T14:36:56.897Z","level":"INFO","message":"Gross pricing detected â€” converting line items and allowances to NET","data":{"lineTotal":100,"totalAmount":100,"taxAmount":100}}

 [32mâœ“[39m tests/unit/lib/extraction-normalizer-taxrate-array.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/api-helpers.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 12[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mreturns hasText: true for digital PDFs with sufficient text
[22m[39m{"timestamp":"2026-02-19T14:36:57.324Z","level":"INFO","message":"PDF text extraction complete","data":{"pageCount":1,"textLength":200,"avgCharsPerPage":200,"hasText":true}}

[90mstdout[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mjoins multiple pages with double newline
[22m[39m{"timestamp":"2026-02-19T14:36:57.331Z","level":"INFO","message":"PDF text extraction complete","data":{"pageCount":2,"textLength":202,"avgCharsPerPage":101,"hasText":true}}

[90mstdout[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mreturns hasText: false for scanned PDFs with little text
[22m[39m{"timestamp":"2026-02-19T14:36:57.332Z","level":"INFO","message":"PDF text extraction complete","data":{"pageCount":1,"textLength":2,"avgCharsPerPage":2,"hasText":false}}

 [32mâœ“[39m tests/unit/lib/pdf-text-extractor.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 16[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/ocr-extractor.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-normalizer-prompt-contract.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/monetary-validator.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-normalizer-safe-number.test.ts [2m([22m[2m18 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m tests/unit/batch/credit-idempotency.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-normalizer-en16931.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/admin/transaction.admin.service.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m tests/unit/batch-format-validation.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/queue/workers-shutdown.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 11[2mms[22m[39m
 [32mâœ“[39m tests/unit/canonical-mapper.test.ts [2m([22m[2m19 tests[22m[2m)[22m[32m 13[2mms[22m[39m
 [32mâœ“[39m tests/unit/adapters/paypal.adapter.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/format-registry.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/facturx-profile-mapping-integration.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/session.test.ts [2m([22m[2m18 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/queue/dead-letter-wiring.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/ai/mistral.extractor.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[32m 10[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/rate-limiter.test.ts
[22m[39m{"timestamp":"2026-02-19T14:37:05.549Z","level":"INFO","message":"Redis not configured, using in-memory rate limiter (development only)"}

 [32mâœ“[39m tests/unit/lib/rate-limiter.test.ts [2m([22m[2m9 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/validators.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/format-readiness.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/monetary.test.ts [2m([22m[2m27 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/extraction/extraction-prompt.contract.test.ts [2m([22m[2m11 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/database-helpers.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/errors.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/gemini.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/database.service.test.ts [2m([22m[2m21 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/cors.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/validation-error-propagation.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/invoice-review-payload.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/validation/monetary-validator.net-gross.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/text-extraction.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/credits/credit-concurrency.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/format-utils.test.ts [2m([22m[2m15 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-retry.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 5[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m97 passed[39m[22m[90m (98)[39m
[2m      Tests [22m [1m[32m1503 passed[39m[22m[90m (1503)[39m
[2m   Start at [22m 15:36:16
[2m   Duration [22m 54.84s[2m (transform 77.62s, setup 52.70s, collect 145.69s, tests 9.25s, environment 438.22s, prepare 44.34s)[22m

