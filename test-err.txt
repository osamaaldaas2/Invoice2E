[90mstderr[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2msendPrompt[2m > [22m[2mshould use local text extraction then send prompt to chat
[22m[39mWarning: Indexing all PDF objects

[90mstderr[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2msendPrompt[2m > [22m[2mshould use local text extraction then send prompt to chat
[22m[39m{"timestamp":"2026-02-19T09:33:49.491Z","level":"WARN","message":"Paged PDF text extraction failed","data":{"error":"Invalid PDF structure."}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice number
[22m[39m{"timestamp":"2026-02-19T09:33:49.927Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-001] Invoice number is required"}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice date
[22m[39m{"timestamp":"2026-02-19T09:33:49.929Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-002] Invoice date is required"}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject invalid total amount
[22m[39m{"timestamp":"2026-02-19T09:33:49.930Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-005] Total amount must be greater than 0\n[BR-CO-15] Invoice total with VAT does not match subtotal + tax amount"}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject empty line items
[22m[39m{"timestamp":"2026-02-19T09:33:49.931Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-006] At least one line item is required"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-001 Empty IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:33:49.978Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-23-a] Seller IBAN is required for SEPA credit transfer (TypeCode 58) (BR-DE-23-a)"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-002 Null IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:33:49.980Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-23-a] Seller IBAN is required for SEPA credit transfer (TypeCode 58) (BR-DE-23-a)"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-003 Undefined IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:33:49.981Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-23-a] Seller IBAN is required for SEPA credit transfer (TypeCode 58) (BR-DE-23-a)"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-001 No buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:33:49.982Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[PEPPOL-EN16931-R010] Buyer electronic address (BT-49) is required for XRechnung"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-002 Null buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:33:49.982Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[PEPPOL-EN16931-R010] Buyer electronic address (BT-49) is required for XRechnung"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-003 No seller electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:33:49.983Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-2] Seller contact information is incomplete: missing email address (BR-DE-2)\n[BR-DE-SELLER-EADDR] Seller electronic address (BT-34) is required for XRechnung"}}

[90mstderr[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mxrechnung-cii â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:33:50.969Z","level":"WARN","message":"XRechnung: Missing seller phone number (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:33:50.969Z","level":"WARN","message":"XRechnung: Missing seller email (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:33:50.969Z","level":"WARN","message":"XRechnung: Missing seller IBAN (BR-DE-23-a requires this for bank transfers)","data":{"seller":"Min Seller GmbH"}}

[90mstderr[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:33:50.972Z","level":"WARN","message":"XRechnung: Missing seller phone number (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:33:50.972Z","level":"WARN","message":"XRechnung: Missing seller email (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:33:50.972Z","level":"WARN","message":"XRechnung: Missing seller IBAN (BR-DE-23-a requires this for bank transfers)","data":{"seller":"Min Seller GmbH"}}

[90mstderr[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:33:50.978Z","level":"WARN","message":"XRechnung: Missing seller phone number (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:33:50.978Z","level":"WARN","message":"XRechnung: Missing seller email (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:33:50.978Z","level":"WARN","message":"XRechnung: Missing seller IBAN (BR-DE-23-a requires this for bank transfers)","data":{"seller":"Min Seller GmbH"}}

[90mstderr[2m | lib/feature-flags/feature-flags.test.ts[2m > [22m[2mFeatureFlagService[2m > [22m[2merror handling[2m > [22m[2mreturns false when DB query fails (fail closed)
[22m[39m{"timestamp":"2026-02-19T09:33:52.913Z","level":"ERROR","message":"Failed to evaluate feature flag","data":{"flagId":"any_flag","error":{"code":"FEATURE_FLAG_LOAD_FAILED","statusCode":500,"name":"AppError"}}}

[90mstderr[2m | tests/unit/adapters/stripe.adapter.test.ts[2m > [22m[2mStripeAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T09:33:53.054Z","level":"ERROR","message":"Stripe checkout session creation failed","data":{"error":"Error message"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "ignore previous instructions"
[22m[39m{"timestamp":"2026-02-19T09:33:53.081Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "disregard prior rules"
[22m[39m{"timestamp":"2026-02-19T09:33:53.092Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "forget previous prompts"
[22m[39m{"timestamp":"2026-02-19T09:33:53.092Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "override earlier rules"
[22m[39m{"timestamp":"2026-02-19T09:33:53.092Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "you are now a" role hijack
[22m[39m{"timestamp":"2026-02-19T09:33:53.093Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "act as if" role hijack
[22m[39m{"timestamp":"2026-02-19T09:33:53.093Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "pretend to be" role hijack
[22m[39m{"timestamp":"2026-02-19T09:33:53.093Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "switch to X mode"
[22m[39m{"timestamp":"2026-02-19T09:33:53.094Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs system prompt reveal attempts
[22m[39m{"timestamp":"2026-02-19T09:33:53.094Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.094Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.094Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.094Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs LLM format markers [INST]
[22m[39m{"timestamp":"2026-02-19T09:33:53.095Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":2,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs Llama format markers <<SYS>>
[22m[39m{"timestamp":"2026-02-19T09:33:53.095Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":2,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs ChatML format markers
[22m[39m{"timestamp":"2026-02-19T09:33:53.095Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":2,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs role markers at line start
[22m[39m{"timestamp":"2026-02-19T09:33:53.096Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.096Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.096Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs output manipulation patterns
[22m[39m{"timestamp":"2026-02-19T09:33:53.096Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.096Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.096Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:33:53.096Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mhandles case-insensitive injection patterns
[22m[39m{"timestamp":"2026-02-19T09:33:53.097Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mhandles multi-vector attack combining invisible chars + injection
[22m[39m{"timestamp":"2026-02-19T09:33:53.098Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mhandles injection hidden across lines
[22m[39m{"timestamp":"2026-02-19T09:33:53.098Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/adapters/supabase.adapter.test.ts[2m > [22m[2mSupabaseAdapter[2m > [22m[2mshould handle operation timeout
[22m[39m{"timestamp":"2026-02-19T09:33:53.196Z","level":"ERROR","message":"Database operation timeout","data":{"duration":20,"timeoutMs":10}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:33:53.703Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"20904183-2747-455f-8dc8-e4e9d48049fd","failedStep":"extract","error":"extract execute failed"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T09:33:53.704Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"2ac34ac4-39ba-43ac-8620-c79f381e8d21","failedStep":"failStep","error":"boom"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould not compensate any steps when the first step fails
[22m[39m{"timestamp":"2026-02-19T09:33:53.705Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"313710f8-2c61-4bb1-87eb-7329f1058f9f","failedStep":"validate","error":"validate execute failed"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:33:53.707Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"c3166a4d-f0e5-4059-9510-72196d0d0729","failedStep":"convert","error":"convert execute failed"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:33:53.707Z","level":"ERROR","message":"Saga compensation failed","data":{"sagaId":"c3166a4d-f0e5-4059-9510-72196d0d0729","step":"deduct","error":"deduct compensate failed"}}

[90mstderr[2m | tests/unit/external-validation.test.ts[2m > [22m[2mXRechnungValidator.validateExternal[2m > [22m[2mshould return error when JAR path is not set
[22m[39m{"timestamp":"2026-02-19T09:33:54.782Z","level":"WARN","message":"External validation enabled but KOSIT_VALIDATOR_JAR not found","data":{"jarPath":""}}

[90mstderr[2m | tests/unit/external-validation.test.ts[2m > [22m[2mXRechnungValidator.validateExternal[2m > [22m[2mshould return error when JAR file does not exist
[22m[39m{"timestamp":"2026-02-19T09:33:54.787Z","level":"WARN","message":"External validation enabled but KOSIT_VALIDATOR_JAR not found","data":{"jarPath":"/nonexistent/validator.jar"}}

[90mstderr[2m | tests/unit/external-validation.test.ts[2m > [22m[2mXRechnungValidator.validateExternal[2m > [22m[2mshould return error when scenarios XML is missing
[22m[39m{"timestamp":"2026-02-19T09:33:54.793Z","level":"WARN","message":"External validation enabled but KOSIT_SCENARIOS_XML not found","data":{"scenariosPath":""}}

[90mstderr[2m | lib/state-machine/invoice-machine.test.ts[2m > [22m[2mgetNextStates[2m > [22m[2mshould return empty array from ARCHIVED
[22m[39mEvent "UPLOAD" was sent to stopped actor "x:47 (x:47)". This actor has already reached its final state, and will not transition.
Event: {"type":"UPLOAD"}
Event "QUARANTINE" was sent to stopped actor "x:48 (x:48)". This actor has already reached its final state, and will not transition.
Event: {"type":"QUARANTINE"}
Event "SCAN_PASS" was sent to stopped actor "x:49 (x:49)". This actor has already reached its final state, and will not transition.
Event: {"type":"SCAN_PASS"}
Event "SCAN_FAIL" was sent to stopped actor "x:50 (x:50)". This actor has already reached its final state, and will not transition.
Event: {"type":"SCAN_FAIL"}
Event "EXTRACT" was sent to stopped actor "x:51 (x:51)". This actor has already reached its final state, and will not transition.
Event: {"type":"EXTRACT"}
Event "EXTRACT_SUCCESS" was sent to stopped actor "x:52 (x:52)". This actor has already reached its final state, and will not transition.
Event: {"type":"EXTRACT_SUCCESS"}
Event "EXTRACT_FAIL" was sent to stopped actor "x:53 (x:53)". This actor has already reached its final state, and will not transition.
Event: {"type":"EXTRACT_FAIL"}
Event "APPROVE" was sent to stopped actor "x:54 (x:54)". This actor has already reached its final state, and will not transition.
Event: {"type":"APPROVE"}
Event "CONVERT" was sent to stopped actor "x:55 (x:55)". This actor has already reached its final state, and will not transition.
Event: {"type":"CONVERT"}
Event "CONVERT_SUCCESS" was sent to stopped actor "x:56 (x:56)". This actor has already reached its final state, and will not transition.
Event: {"type":"CONVERT_SUCCESS"}
Event "CONVERT_FAIL" was sent to stopped actor "x:57 (x:57)". This actor has already reached its final state, and will not transition.
Event: {"type":"CONVERT_FAIL"}
Event "ARCHIVE" was sent to stopped actor "x:58 (x:58)". This actor has already reached its final state, and will not transition.
Event: {"type":"ARCHIVE"}
Event "RETRY" was sent to stopped actor "x:59 (x:59)". This actor has already reached its final state, and will not transition.
Event: {"type":"RETRY"}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2msanitizeXml[2m > [22m[2mshould strip simple DOCTYPE declarations
[22m[39m{"timestamp":"2026-02-19T09:33:57.612Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2msanitizeXml[2m > [22m[2mshould throw on SYSTEM entity (XXE)
[22m[39m{"timestamp":"2026-02-19T09:33:57.617Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}
{"timestamp":"2026-02-19T09:33:57.618Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2msanitizeXml[2m > [22m[2mshould throw on PUBLIC entity (XXE)
[22m[39m{"timestamp":"2026-02-19T09:33:57.619Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2mparseXmlSafe[2m > [22m[2mshould throw on XXE attack
[22m[39m{"timestamp":"2026-02-19T09:33:57.623Z","level":"WARN","message":"xml-security: parseXmlSafe rejected XML","data":{"code":"DOCTYPE_REJECTED","reason":"XML contains a DOCTYPE declaration â€” DTDs are not allowed"}}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2mparseXmlSafe[2m > [22m[2mshould throw on billion laughs (excessive entities)
[22m[39m{"timestamp":"2026-02-19T09:33:57.624Z","level":"WARN","message":"xml-security: parseXmlSafe rejected XML","data":{"code":"ENTITY_EXPANSION_LIMIT","reason":"XML contains 600 entity references (limit: 500) â€” possible billion laughs attack"}}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2mparseXmlSafe[2m > [22m[2mshould throw on oversized XML
[22m[39m{"timestamp":"2026-02-19T09:33:57.624Z","level":"WARN","message":"xml-security: parseXmlSafe rejected XML","data":{"code":"XML_TOO_LARGE","reason":"XML size 1037 bytes exceeds limit of 100 bytes"}}

[90mstderr[2m | tests/unit/adapters/sendgrid.adapter.test.ts[2m > [22m[2mSendGridAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T09:33:58.856Z","level":"ERROR","message":"SendGrid API error","data":{"status":400,"body":"Bad Request"}}

[90mstderr[2m | tests/unit/adapters/sendgrid.adapter.test.ts[2m > [22m[2mSendGridAdapter[2m > [22m[2mshould handle configuration error
[22m[39m{"timestamp":"2026-02-19T09:33:58.862Z","level":"WARN","message":"SendGrid not configured"}

[90mstderr[2m | lib/rbac/rbac.test.ts[2m > [22m[2mUnknown Role[2m > [22m[2mshould have no permissions
[22m[39m{"timestamp":"2026-02-19T09:33:58.928Z","level":"ERROR","message":"Unknown role encountered in RBAC ability builder","data":{"role":"unknown","userId":"unknown-1"}}

[90mstderr[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle API timeouts
[22m[39m{"timestamp":"2026-02-19T09:33:59.354Z","level":"ERROR","message":"OpenAI API timeout","data":{"processingTimeMs":0}}

[90mstderr[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T09:33:59.356Z","level":"ERROR","message":"JSON parsing failed","data":{"responseLength":12}}
{"timestamp":"2026-02-19T09:33:59.356Z","level":"ERROR","message":"OpenAI extraction failed","data":{"processingTimeMs":0,"errorMessage":"Invalid JSON response from OpenAI"}}

[90mstderr[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T09:33:59.468Z","level":"WARN","message":"Gemini response parse failed","data":{"responseLength":12}}
{"timestamp":"2026-02-19T09:33:59.468Z","level":"ERROR","message":"Gemini extraction failed","data":{"message":"Failed to parse Gemini response"}}
{"timestamp":"2026-02-19T09:33:59.468Z","level":"WARN","message":"Gemini extraction failure context","data":{"responseTime":1,"errorType":"AppError"}}

[90mstderr[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T09:33:59.469Z","level":"ERROR","message":"Gemini extraction failed","data":{"message":"API Error"}}
{"timestamp":"2026-02-19T09:33:59.469Z","level":"WARN","message":"Gemini extraction failure context","data":{"responseTime":0,"errorType":"Error"}}

[90mstderr[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mreturns hasText: false on parse error
[22m[39m{"timestamp":"2026-02-19T09:34:01.465Z","level":"WARN","message":"PDF text extraction failed, treating as scanned","data":{"error":"corrupt PDF"}}

[90mstderr[2m | tests/unit/xml-utils.test.ts[2m > [22m[2mformatDateISO[2m > [22m[2mrejects ambiguous slash formats
[22m[39m{"timestamp":"2026-02-19T09:34:01.582Z","level":"WARN","message":"xml-utils: Ambiguous date format rejected","data":{"date":"01/02/2024"}}

[90mstderr[2m | tests/unit/xml-utils.test.ts[2m > [22m[2mformatDateCII[2m > [22m[2mrejects ambiguous slash formats
[22m[39m{"timestamp":"2026-02-19T09:34:01.590Z","level":"WARN","message":"xml-utils: Ambiguous date format rejected","data":{"date":"01/02/2024"}}

[90mstderr[2m | tests/unit/lib/extraction-normalizer-safe-number.test.ts[2m > [22m[2mnormalizeExtractedData â€” monetary fields with locale formats[2m > [22m[2mdefaults totalAmount to 0 when completely unparseable (not silent NaNâ†’0)
[22m[39m{"timestamp":"2026-02-19T09:34:02.884Z","level":"WARN","message":"totalAmount is not a valid number, defaulting to 0","data":{"raw":"N/A"}}

[2m10:34:06[22m [33m[1m[vite][22m[39m [33m[2m(client)[22m[39m [33mwarning: [33mDuplicate key "createAdminClient" in object literal[33m
50 |  vi.mock('@/lib/supabase.server', () => ({
51 |    createAdminClient: vi.fn(() => mockChain),
52 |    createAdminClient: vi.fn(() => mockChain),
   |    ^
53 |    createUserScopedClient: vi.fn(() => Promise.resolve(mockChain)),
54 |  }));
[39m
  Plugin: [35mvite:esbuild[39m
  File: [36mC:/Users/osama/Desktop/Invoice2E.1/tests/unit/batch/credit-idempotency.test.ts[39m
[90mstderr[2m | tests/unit/lib/rate-limiter.test.ts[2m > [22m[2mRate Limiter[2m > [22m[2mcheckRateLimit[2m > [22m[2mshould block after limit exceeded
[22m[39m{"timestamp":"2026-02-19T09:34:11.479Z","level":"WARN","message":"Rate limit (memory): Too many attempts, blocking","data":{"identifier":"spam-test-id","preset":"login","attempts":6,"blockedForSeconds":900}}
{"timestamp":"2026-02-19T09:34:11.479Z","level":"WARN","message":"Rate limit (memory): Request blocked","data":{"identifier":"spam-test-id","blockedForSeconds":900}}


[31mâ¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Suites 1 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m .agent/skills/scripts/tests/validate_skills_headings.test.js[2m [ .agent/skills/scripts/tests/validate_skills_headings.test.js ][22m
[31m[1mError[22m: No test suite found in file C:/Users/osama/Desktop/Invoice2E.1/.agent/skills/scripts/tests/validate_skills_headings.test.js[39m
[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯[22m[39m

