
[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mC:/Users/osama/Desktop/Invoice2E.1[39m

 [32mâœ“[39m tests/unit/routes/batch-worker.route.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 171[2mms[22m[39m
 [32mâœ“[39m tests/unit/file.service.test.ts [2m([22m[2m22 tests[22m[2m)[22m[32m 35[2mms[22m[39m
[90mstderr[2m | tests/unit/adapters/supabase.adapter.test.ts[2m > [22m[2mSupabaseAdapter[2m > [22m[2mshould handle operation timeout
[22m[39m{"timestamp":"2026-02-19T09:32:08.091Z","level":"ERROR","message":"Database operation timeout","data":{"duration":15,"timeoutMs":10}}

 [32mâœ“[39m tests/unit/adapters/supabase.adapter.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 26[2mms[22m[39m
 [32mâœ“[39m tests/unit/utils.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 38[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/sanitizer.test.ts [2m([22m[2m20 tests[22m[2m)[22m[32m 61[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2mextractInvoiceData[2m > [22m[2mshould perform two-step extraction (OCR + Chat)
[22m[39m{"timestamp":"2026-02-19T09:32:08.286Z","level":"INFO","message":"Mistral extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2mextractInvoiceData[2m > [22m[2mshould perform two-step extraction (OCR + Chat)
[22m[39m{"timestamp":"2026-02-19T09:32:08.293Z","level":"INFO","message":"Mistral extraction successful","data":{"processingTimeMs":7,"confidence":0.7}}

[90mstdout[2m | .agent/skills/scripts/tests/validate_skills_headings.test.js
[22m[39mChecking YAML validity for 853 skills...
ok

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould generate valid XML for complete invoice data
[22m[39m{"timestamp":"2026-02-19T09:32:08.317Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.326Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice number
[22m[39m{"timestamp":"2026-02-19T09:32:08.330Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":null}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice number
[22m[39m{"timestamp":"2026-02-19T09:32:08.330Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-001] Invoice number is required"}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice date
[22m[39m{"timestamp":"2026-02-19T09:32:08.332Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject missing invoice date
[22m[39m{"timestamp":"2026-02-19T09:32:08.332Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-002] Invoice date is required"}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject invalid total amount
[22m[39m{"timestamp":"2026-02-19T09:32:08.332Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject invalid total amount
[22m[39m{"timestamp":"2026-02-19T09:32:08.332Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-005] Total amount must be greater than 0\n[BR-CO-15] Invoice total with VAT does not match subtotal + tax amount"}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject empty line items
[22m[39m{"timestamp":"2026-02-19T09:32:08.333Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}

[90mstderr[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould reject empty line items
[22m[39m{"timestamp":"2026-02-19T09:32:08.333Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[SCHEMA-006] At least one line item is required"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-001 Goods + Books: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.325Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-001"}}
{"timestamp":"2026-02-19T09:32:08.333Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-001","xmlSize":8666,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould escape XML special characters correctly
[22m[39m{"timestamp":"2026-02-19T09:32:08.334Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.334Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6889,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould format dates correctly (YYYYMMDD)
[22m[39m{"timestamp":"2026-02-19T09:32:08.336Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.336Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-001 Goods + Books: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T09:32:08.337Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-001"}}
{"timestamp":"2026-02-19T09:32:08.338Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-001","xmlSize":8666,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-002 Software + Catering: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.339Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-002"}}
{"timestamp":"2026-02-19T09:32:08.340Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-002","xmlSize":8663,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould handle missing optional fields gracefully
[22m[39m{"timestamp":"2026-02-19T09:32:08.341Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.341Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6961,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-002 Software + Catering: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T09:32:08.342Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-002"}}
{"timestamp":"2026-02-19T09:32:08.342Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-002","xmlSize":8663,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould include tax breakdown calculations
[22m[39m{"timestamp":"2026-02-19T09:32:08.342Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.343Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-003 Hardware + Shipping: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.344Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-003"}}
{"timestamp":"2026-02-19T09:32:08.344Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-003","xmlSize":10024,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould map buyerElectronicAddress to XML URIUniversalCommunication with correct scheme
[22m[39m{"timestamp":"2026-02-19T09:32:08.345Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.346Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6863,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-003 Hardware + Shipping: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T09:32:08.347Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-003"}}
{"timestamp":"2026-02-19T09:32:08.347Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-003","xmlSize":10024,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould use auto-detected scheme 0204 for non-email buyerElectronicAddress
[22m[39m{"timestamp":"2026-02-19T09:32:08.348Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.348Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6857,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-004 3 items at 19% + 2 items at 7%: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.349Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-004"}}
{"timestamp":"2026-02-19T09:32:08.350Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-004","xmlSize":12750,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mT5: should default to EM scheme for non-PEPPOL, non-email electronic address
[22m[39m{"timestamp":"2026-02-19T09:32:08.350Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.350Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6858,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-004 3 items at 19% + 2 items at 7%: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T09:32:08.352Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-004"}}
{"timestamp":"2026-02-19T09:32:08.352Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-004","xmlSize":12750,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mT5: should use explicit scheme when provided (seller)
[22m[39m{"timestamp":"2026-02-19T09:32:08.354Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.354Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6858,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-005 Small amounts 7% + 19%: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.354Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-005"}}
{"timestamp":"2026-02-19T09:32:08.354Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-005","xmlSize":8622,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung.service.test.ts[2m > [22m[2mXRechnungService[2m > [22m[2mgenerateXRechnung[2m > [22m[2mshould use recomputed total (not raw totalAmount) for GrandTotalAmount (F1)
[22m[39m{"timestamp":"2026-02-19T09:32:08.356Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INV-001"}}
{"timestamp":"2026-02-19T09:32:08.357Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INV-001","xmlSize":6854,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mA: Mixed VAT invoices (7% + 19%)[2m > [22m[2mMIX-005 Small amounts 7% + 19%: XML should contain multiple tax breakdowns
[22m[39m{"timestamp":"2026-02-19T09:32:08.356Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-MIX-005"}}
{"timestamp":"2026-02-19T09:32:08.356Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-MIX-005","xmlSize":8622,"warnings":0}}

[90mstdout[2m | tests/unit/pdf-splitter.service.test.ts[2m > [22m[2mPdfSplitterService[2m > [22m[2msplitByPageGroups[2m > [22m[2mshould split a 4-page PDF into 2 groups
[22m[39m{"timestamp":"2026-02-19T09:32:08.351Z","level":"INFO","message":"PDF split completed","data":{"sourcePages":4,"groups":2,"groupSizes":[2,2]}}

 [32mâœ“[39m tests/unit/xrechnung.service.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 44[2mms[22m[39m
[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mB: Credit Notes (documentTypeCode 381)[2m > [22m[2mCN-001 Simple refund (19%): should generate valid XML with TypeCode 381
[22m[39m{"timestamp":"2026-02-19T09:32:08.360Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-CN-001"}}
{"timestamp":"2026-02-19T09:32:08.360Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-CN-001","xmlSize":7065,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mB: Credit Notes (documentTypeCode 381)[2m > [22m[2mCN-002 Multi-line refund (mixed rates): should generate valid XML with TypeCode 381
[22m[39m{"timestamp":"2026-02-19T09:32:08.362Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-CN-002"}}
{"timestamp":"2026-02-19T09:32:08.362Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-CN-002","xmlSize":8811,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mB: Credit Notes (documentTypeCode 381)[2m > [22m[2mCN-003 Partial refund (19%): should generate valid XML with TypeCode 381
[22m[39m{"timestamp":"2026-02-19T09:32:08.364Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-CN-003"}}
{"timestamp":"2026-02-19T09:32:08.365Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-CN-003","xmlSize":7073,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-001 Empty IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.367Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOIBAN-001"}}

[90mstdout[2m | tests/unit/pdf-splitter.service.test.ts[2m > [22m[2mPdfSplitterService[2m > [22m[2msplitByPageGroups[2m > [22m[2mshould handle single-page groups
[22m[39m{"timestamp":"2026-02-19T09:32:08.368Z","level":"INFO","message":"PDF split completed","data":{"sourcePages":3,"groups":3,"groupSizes":[1,1,1]}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-001 Empty IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.367Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-23-a] Seller IBAN is required for SEPA credit transfer (TypeCode 58) (BR-DE-23-a)"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-002 Null IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.368Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOIBAN-002"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-002 Null IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.369Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-23-a] Seller IBAN is required for SEPA credit transfer (TypeCode 58) (BR-DE-23-a)"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-003 Undefined IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.369Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOIBAN-003"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mC: Missing IBAN (should fail BR-DE-23-a)[2m > [22m[2mNOIBAN-003 Undefined IBAN: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.369Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-23-a] Seller IBAN is required for SEPA credit transfer (TypeCode 58) (BR-DE-23-a)"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-001 No buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.370Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOENDPOINT-001"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-001 No buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.370Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[PEPPOL-EN16931-R010] Buyer electronic address (BT-49) is required for XRechnung"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-002 Null buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.371Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOENDPOINT-002"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-002 Null buyer electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.371Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[PEPPOL-EN16931-R010] Buyer electronic address (BT-49) is required for XRechnung"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-003 No seller electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.371Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-NOENDPOINT-003"}}

[90mstderr[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mD: Missing Buyer Electronic Address (should fail PEPPOL-EN16931-R010)[2m > [22m[2mNOENDPOINT-003 No seller electronic address: generateXRechnung should throw ValidationError
[22m[39m{"timestamp":"2026-02-19T09:32:08.371Z","level":"ERROR","message":"XRechnung generation failed","data":{"message":"XRechnung validation failed:\n[BR-DE-2] Seller contact information is incomplete: missing email address (BR-DE-2)\n[BR-DE-SELLER-EADDR] Seller electronic address (BT-34) is required for XRechnung"}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.372Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T09:32:08.373Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/pdf-splitter.service.test.ts[2m > [22m[2mPdfSplitterService[2m > [22m[2msplitByPageGroups[2m > [22m[2mshould handle uneven page groups
[22m[39m{"timestamp":"2026-02-19T09:32:08.374Z","level":"INFO","message":"PDF split completed","data":{"sourcePages":5,"groups":2,"groupSizes":[3,2]}}

[90mstderr[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2msendPrompt[2m > [22m[2mshould use local text extraction then send prompt to chat
[22m[39mWarning: Indexing all PDF objects

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should contain CategoryCode Z
[22m[39m{"timestamp":"2026-02-19T09:32:08.374Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T09:32:08.374Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstderr[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2msendPrompt[2m > [22m[2mshould use local text extraction then send prompt to chat
[22m[39m{"timestamp":"2026-02-19T09:32:08.380Z","level":"WARN","message":"Paged PDF text extraction failed","data":{"error":"Invalid PDF structure."}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should contain ExemptionReason for Z
[22m[39m{"timestamp":"2026-02-19T09:32:08.376Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T09:32:08.376Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/adapters/mistral.adapter.test.ts[2m > [22m[2mMistralAdapter[2m > [22m[2msendPrompt[2m > [22m[2mshould use local text extraction then send prompt to chat
[22m[39m{"timestamp":"2026-02-19T09:32:08.380Z","level":"INFO","message":"sendPrompt using flat text extraction","data":{"source":"unpdf","textLength":23}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T09:32:08.377Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T09:32:08.378Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

 [32mâœ“[39m tests/unit/pdf-splitter.service.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 64[2mms[22m[39m
[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF1 ZERORATED-Z-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T09:32:08.379Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"ZERORATED-Z-001"}}
{"timestamp":"2026-02-19T09:32:08.379Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"ZERORATED-Z-001","xmlSize":8371,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.381Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T09:32:08.381Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain CategoryCode AE
[22m[39m{"timestamp":"2026-02-19T09:32:08.382Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T09:32:08.383Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

 [32mâœ“[39m tests/unit/adapters/mistral.adapter.test.ts [2m([22m[2m9 tests[22m[2m)[22m[32m 100[2mms[22m[39m
[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain ExemptionReason for AE
[22m[39m{"timestamp":"2026-02-19T09:32:08.385Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T09:32:08.385Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T09:32:08.387Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T09:32:08.387Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T09:32:08.388Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T09:32:08.389Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mF: Zero-rated (Z) and Reverse charge (AE)[2m > [22m[2mF2 REVERSE-AE-001: XML should contain buyer VAT ID
[22m[39m{"timestamp":"2026-02-19T09:32:08.390Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"REVERSE-AE-001"}}
{"timestamp":"2026-02-19T09:32:08.390Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"REVERSE-AE-001","xmlSize":8594,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.392Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T09:32:08.392Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain CategoryCode K
[22m[39m{"timestamp":"2026-02-19T09:32:08.393Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T09:32:08.394Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain ExemptionReason for K
[22m[39m{"timestamp":"2026-02-19T09:32:08.395Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T09:32:08.395Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T09:32:08.397Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T09:32:08.397Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T09:32:08.399Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T09:32:08.400Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mINTRA-K-001: XML should contain buyer VAT ID
[22m[39m{"timestamp":"2026-02-19T09:32:08.402Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"INTRA-K-001"}}
{"timestamp":"2026-02-19T09:32:08.402Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"INTRA-K-001","xmlSize":8549,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.404Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T09:32:08.404Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should contain CategoryCode G
[22m[39m{"timestamp":"2026-02-19T09:32:08.407Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T09:32:08.408Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should contain ExemptionReason for G
[22m[39m{"timestamp":"2026-02-19T09:32:08.410Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T09:32:08.410Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T09:32:08.412Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T09:32:08.412Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mEXPORT-G-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T09:32:08.415Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"EXPORT-G-001"}}
{"timestamp":"2026-02-19T09:32:08.416Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"EXPORT-G-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.418Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T09:32:08.418Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should contain CategoryCode O
[22m[39m{"timestamp":"2026-02-19T09:32:08.423Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T09:32:08.423Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should contain ExemptionReason for O
[22m[39m{"timestamp":"2026-02-19T09:32:08.428Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T09:32:08.428Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T09:32:08.430Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T09:32:08.430Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mNOTSUBJ-O-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T09:32:08.431Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"NOTSUBJ-O-001"}}
{"timestamp":"2026-02-19T09:32:08.432Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"NOTSUBJ-O-001","xmlSize":8387,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: should generate valid XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.434Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T09:32:08.434Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should contain CategoryCode L
[22m[39m{"timestamp":"2026-02-19T09:32:08.436Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T09:32:08.436Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should contain ExemptionReason for L
[22m[39m{"timestamp":"2026-02-19T09:32:08.438Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T09:32:08.438Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should contain RateApplicablePercent 0.00
[22m[39m{"timestamp":"2026-02-19T09:32:08.439Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T09:32:08.439Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mG: Intra-community (K), Export (G), Not subject (O), Canary Islands (L)[2m > [22m[2mCANARY-L-001: XML should have TaxTotalAmount = 0 and GrandTotal = subtotal
[22m[39m{"timestamp":"2026-02-19T09:32:08.441Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"CANARY-L-001"}}
{"timestamp":"2026-02-19T09:32:08.442Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"CANARY-L-001","xmlSize":8408,"warnings":0}}

[90mstdout[2m | tests/unit/xrechnung-fixtures.test.ts[2m > [22m[2mE: Edge cases[2m > [22m[2mZero-rate line item with taxCategoryCode E (exempt)
[22m[39m{"timestamp":"2026-02-19T09:32:08.444Z","level":"INFO","message":"Starting XRechnung 3.0 generation (EN 16931 compliant)","data":{"invoiceNumber":"TEST-EDGE-EXEMPT"}}
{"timestamp":"2026-02-19T09:32:08.444Z","level":"INFO","message":"XRechnung generated successfully","data":{"invoiceNumber":"TEST-EDGE-EXEMPT","xmlSize":6979,"warnings":0}}

 [32mâœ“[39m tests/unit/xrechnung-fixtures.test.ts [2m([22m[2m75 tests[22m[2m)[22m[32m 124[2mms[22m[39m
[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mgenerates PDF output with pdfContent buffer
[22m[39m{"timestamp":"2026-02-19T09:32:08.660Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mgenerates valid PDF that pdf-lib can parse
[22m[39m{"timestamp":"2026-02-19T09:32:08.727Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mPDF filename ends with _facturx.pdf
[22m[39m{"timestamp":"2026-02-19T09:32:08.742Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mfileSize matches pdfContent length
[22m[39m{"timestamp":"2026-02-19T09:32:08.751Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2malso produces xmlContent with CII XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.757Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2membedded XML has correct Factur-X EN16931 SpecificationID
[22m[39m{"timestamp":"2026-02-19T09:32:08.765Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2membedded XML has correct Factur-X BASIC SpecificationID
[22m[39m{"timestamp":"2026-02-19T09:32:08.772Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mdoes NOT contain XRechnung SpecificationID
[22m[39m{"timestamp":"2026-02-19T09:32:08.779Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mincludes standard invoice fields in XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.790Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mincludes seller and buyer info in XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.805Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles credit notes (TypeCode 381)
[22m[39m{"timestamp":"2026-02-19T09:32:08.812Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles non-EUR currency (USD)
[22m[39m{"timestamp":"2026-02-19T09:32:08.819Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles GBP currency
[22m[39m{"timestamp":"2026-02-19T09:32:08.824Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mhandles allowances/charges
[22m[39m{"timestamp":"2026-02-19T09:32:08.829Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mvisual PDF has at least one page
[22m[39m{"timestamp":"2026-02-19T09:32:08.835Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFacturXGenerator[2m > [22m[2mvalidate()[2m > [22m[2mpasses for valid Factur-X XML
[22m[39m{"timestamp":"2026-02-19T09:32:08.860Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"FX-2024-001"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFactur-X factory registration[2m > [22m[2mGeneratorFactory.create("facturx-en16931") returns FacturXGenerator
[22m[39m{"timestamp":"2026-02-19T09:32:08.871Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFactur-X factory registration[2m > [22m[2mGeneratorFactory.create("facturx-basic") returns FacturXGenerator
[22m[39m{"timestamp":"2026-02-19T09:32:08.871Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}

[90mstdout[2m | tests/unit/facturx.test.ts[2m > [22m[2mFactur-X factory registration[2m > [22m[2mreturns cached singleton for facturx-en16931
[22m[39m{"timestamp":"2026-02-19T09:32:08.872Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: xrechnung-cii[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.865Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: xrechnung-ubl[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.878Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T09:32:08.878Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.880Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: peppol-bis[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.881Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T09:32:08.881Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.882Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: facturx-en16931[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.884Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T09:32:08.884Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"GOLDEN-2024-001"}}

 [32mâœ“[39m tests/unit/facturx.test.ts [2m([22m[2m38 tests[22m[2m)[22m[32m 217[2mms[22m[39m
[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mxrechnung-cii â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:08.934Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: facturx-basic[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.945Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T09:32:08.946Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"GOLDEN-2024-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:08.946Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T09:32:08.947Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T09:32:08.948Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-cii[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:08.941Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:08.949Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T09:32:08.950Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T09:32:08.950Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:08.951Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T09:32:08.951Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-ZEROTAX-001"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: fatturapa[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.956Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-cii[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:08.959Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: ksef[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.958Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-ubl[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:08.962Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T09:32:08.963Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.964Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: xrechnung-ubl[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:08.964Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T09:32:08.964Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.965Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: peppol-bis[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:08.965Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T09:32:08.965Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.966Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: peppol-bis[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:08.966Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T09:32:08.966Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.967Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-en16931[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:08.967Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T09:32:08.967Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: nlcius[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.985Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T09:32:08.985Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.985Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/golden-files.test.ts[2m > [22m[2mGolden File Tests[2m > [22m[2mformat: cius-ro[2m > [22m[2mmatches golden file (or creates it)
[22m[39m{"timestamp":"2026-02-19T09:32:08.986Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T09:32:08.986Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"GOLDEN-2024-001"}}
{"timestamp":"2026-02-19T09:32:08.986Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

 [32mâœ“[39m tests/unit/golden-files.test.ts [2m([22m[2m9 tests[22m[2m)[22m[32m 126[2mms[22m[39m
[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:08.998Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.008Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T09:32:09.009Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T09:32:09.010Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.011Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T09:32:09.011Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T09:32:09.011Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.012Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T09:32:09.012Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CONSIST-2024-007"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-en16931[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:09.042Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T09:32:09.042Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.067Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T09:32:09.068Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CONSIST-2024-007"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.069Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T09:32:09.069Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-ZEROTAX-001"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.078Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.080Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.081Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T09:32:09.081Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T09:32:09.081Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency
[22m[39m{"timestamp":"2026-02-19T09:32:09.081Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T09:32:09.082Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CONSIST-2024-007"}}
{"timestamp":"2026-02-19T09:32:09.082Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-basic[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:09.094Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T09:32:09.095Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: facturx-basic[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:09.103Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T09:32:09.103Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency[2m > [22m[2mFactur-X formats embed XML in PDF
[22m[39m{"timestamp":"2026-02-19T09:32:09.136Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CONSIST-2024-007"}}

[90mstdout[2m | tests/unit/cross-format-consistency.test.ts[2m > [22m[2mCross-Format Consistency[2m > [22m[2mFactur-X formats embed XML in PDF
[22m[39m{"timestamp":"2026-02-19T09:32:09.146Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CONSIST-2024-007"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mfatturapa â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.122Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mksef â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.150Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.151Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T09:32:09.152Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T09:32:09.152Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mzero-tax (exempt)[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.153Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T09:32:09.153Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ZEROTAX-001"}}
{"timestamp":"2026-02-19T09:32:09.153Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: fatturapa[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:09.152Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: fatturapa[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:09.154Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

 [32mâœ“[39m tests/unit/cross-format-consistency.test.ts [2m([22m[2m56 tests[22m[2m)[22m[32m 156[2mms[22m[39m
[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: ksef[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:09.154Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: ksef[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:09.156Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: nlcius[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:09.156Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T09:32:09.156Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:09.156Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.156Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T09:32:09.156Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: nlcius[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:09.157Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}
{"timestamp":"2026-02-19T09:32:09.157Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:09.157Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.157Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T09:32:09.158Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: cius-ro[2m > [22m[2mgenerates without throwing
[22m[39m{"timestamp":"2026-02-19T09:32:09.158Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T09:32:09.158Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:09.158Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.158Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-CN-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat: cius-ro[2m > [22m[2mreturns non-empty content
[22m[39m{"timestamp":"2026-02-19T09:32:09.158Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}
{"timestamp":"2026-02-19T09:32:09.159Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"CROSS-2024-001"}}
{"timestamp":"2026-02-19T09:32:09.159Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mFactur-X formats return pdfContent (Buffer)
[22m[39m{"timestamp":"2026-02-19T09:32:09.159Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}
{"timestamp":"2026-02-19T09:32:09.159Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mFactur-X formats return pdfContent (Buffer)
[22m[39m{"timestamp":"2026-02-19T09:32:09.191Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}
{"timestamp":"2026-02-19T09:32:09.191Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"CROSS-2024-001"}}

[90mstdout[2m | tests/unit/cross-format.test.ts[2m > [22m[2mCross-Format Integration[2m > [22m[2mformat switching: generate same invoice in format A then format B
[22m[39m{"timestamp":"2026-02-19T09:32:09.197Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}
{"timestamp":"2026-02-19T09:32:09.197Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

 [32mâœ“[39m tests/unit/cross-format.test.ts [2m([22m[2m22 tests[22m[2m)[22m[32m 263[2mms[22m[39m
[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.248Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-CN-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.255Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T09:32:09.256Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mcredit note (381)[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.256Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-CN-001"}}
{"timestamp":"2026-02-19T09:32:09.256Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.258Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T09:32:09.259Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.259Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T09:32:09.259Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.260Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-MULTITAX-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.301Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-MULTITAX-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.307Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T09:32:09.307Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmulti-tax-rate[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.308Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MULTITAX-001"}}
{"timestamp":"2026-02-19T09:32:09.308Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.310Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T09:32:09.311Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.311Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T09:32:09.311Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.311Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-ALLOWANCE-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.382Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-ALLOWANCE-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.390Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T09:32:09.390Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mallowances/charges[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.391Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-ALLOWANCE-001"}}
{"timestamp":"2026-02-19T09:32:09.391Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstderr[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mxrechnung-cii â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.392Z","level":"WARN","message":"XRechnung: Missing seller phone number (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:32:09.392Z","level":"WARN","message":"XRechnung: Missing seller email (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:32:09.392Z","level":"WARN","message":"XRechnung: Missing seller IBAN (BR-DE-23-a requires this for bank transfers)","data":{"seller":"Min Seller GmbH"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.394Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T09:32:09.394Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.394Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T09:32:09.394Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.395Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-MIN-001"}}

[90mstderr[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.395Z","level":"WARN","message":"XRechnung: Missing seller phone number (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:32:09.395Z","level":"WARN","message":"XRechnung: Missing seller email (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:32:09.395Z","level":"WARN","message":"XRechnung: Missing seller IBAN (BR-DE-23-a requires this for bank transfers)","data":{"seller":"Min Seller GmbH"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.416Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-MIN-001"}}

[90mstderr[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.427Z","level":"WARN","message":"XRechnung: Missing seller phone number (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:32:09.427Z","level":"WARN","message":"XRechnung: Missing seller email (BR-DE-2 requires this)","data":{"seller":"Min Seller GmbH"}}
{"timestamp":"2026-02-19T09:32:09.427Z","level":"WARN","message":"XRechnung: Missing seller IBAN (BR-DE-23-a requires this for bank transfers)","data":{"seller":"Min Seller GmbH"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.459Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T09:32:09.459Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mminimum viable[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.459Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MIN-001"}}
{"timestamp":"2026-02-19T09:32:09.459Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.463Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T09:32:09.463Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.464Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T09:32:09.464Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.464Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-MAX-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.471Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-MAX-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.478Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T09:32:09.478Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mmaximum complexity[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.478Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-MAX-001"}}
{"timestamp":"2026-02-19T09:32:09.478Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mxrechnung-ubl â€” rejects or handles gracefully
[22m[39m{"timestamp":"2026-02-19T09:32:09.494Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T09:32:09.494Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.494Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T09:32:09.494Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.495Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-GBP-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.515Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-GBP-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.520Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T09:32:09.520Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mnon-EUR currency (GBP)[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.521Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-GBP-001"}}
{"timestamp":"2026-02-19T09:32:09.521Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.525Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T09:32:09.525Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.526Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T09:32:09.526Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.526Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-LONG-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.531Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-LONG-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.537Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T09:32:09.537Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mvery long fields[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.537Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-LONG-001"}}
{"timestamp":"2026-02-19T09:32:09.537Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mxrechnung-ubl â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.539Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.540Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mpeppol-bis â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.540Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.540Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mfacturx-en16931 â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.543Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mfacturx-basic â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.551Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mnlcius â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.556Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.557Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters[2m > [22m[2mcius-ro â€” generates valid output
[22m[39m{"timestamp":"2026-02-19T09:32:09.557Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.557Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mxrechnung-ubl â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T09:32:09.560Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.560Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mpeppol-bis â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T09:32:09.561Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.561Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mfacturx-en16931 â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T09:32:09.561Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-en16931","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mfacturx-basic â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T09:32:09.565Z","level":"INFO","message":"Generating Factur-X invoice","data":{"format":"facturx-basic","invoiceNumber":"EDGE-SPECIAL-001"}}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mnlcius â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T09:32:09.570Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.570Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/edge-cases.test.ts[2m > [22m[2mEdge Cases[2m > [22m[2mspecial characters XML safety[2m > [22m[2mcius-ro â€” XML entities are properly escaped
[22m[39m{"timestamp":"2026-02-19T09:32:09.571Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"EDGE-SPECIAL-001"}}
{"timestamp":"2026-02-19T09:32:09.571Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

 [32mâœ“[39m tests/unit/edge-cases.test.ts [2m([22m[2m90 tests[22m[2m)[22m[33m 639[2mms[22m[39m
[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mquarantine[2m > [22m[2mshould store file and create entry
[22m[39m{"timestamp":"2026-02-19T09:32:10.897Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"b054c1d4-9176-4a90-8842-6ebae124cd20","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PDF file
[22m[39m{"timestamp":"2026-02-19T09:32:10.915Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"01198390-1d5a-41eb-8235-874b34dc6a2e","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PDF file
[22m[39m{"timestamp":"2026-02-19T09:32:10.915Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"01198390-1d5a-41eb-8235-874b34dc6a2e","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PNG file
[22m[39m{"timestamp":"2026-02-19T09:32:10.917Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"6acbb26d-1c57-4ba3-b1d0-f1bab4db69fb","originalName":"receipt.png","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid PNG file
[22m[39m{"timestamp":"2026-02-19T09:32:10.917Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"6acbb26d-1c57-4ba3-b1d0-f1bab4db69fb","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid JPEG file
[22m[39m{"timestamp":"2026-02-19T09:32:10.918Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"38b6099b-fe62-4860-99fb-8ac19a94430b","originalName":"photo.jpg","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould pass a valid JPEG file
[22m[39m{"timestamp":"2026-02-19T09:32:10.918Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"38b6099b-fe62-4860-99fb-8ac19a94430b","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with invalid extension
[22m[39m{"timestamp":"2026-02-19T09:32:10.919Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"d90167c5-962d-43ea-9b6f-ae665b36fb88","originalName":"malware.exe","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with invalid extension
[22m[39m{"timestamp":"2026-02-19T09:32:10.919Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"d90167c5-962d-43ea-9b6f-ae665b36fb88","isClean":false,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":false},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with magic bytes mismatch
[22m[39m{"timestamp":"2026-02-19T09:32:10.920Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"c7b7d10a-aedb-4612-9adf-b466a9c74e12","originalName":"fake.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with magic bytes mismatch
[22m[39m{"timestamp":"2026-02-19T09:32:10.921Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"c7b7d10a-aedb-4612-9adf-b466a9c74e12","isClean":false,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":false}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject oversized file
[22m[39m{"timestamp":"2026-02-19T09:32:10.921Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"0a45b2be-59d3-4df1-85ba-18be623ffc65","originalName":"invoice.pdf","size":27262976}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject oversized file
[22m[39m{"timestamp":"2026-02-19T09:32:10.921Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"0a45b2be-59d3-4df1-85ba-18be623ffc65","isClean":false,"checks":[{"name":"file_size","passed":false},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with disallowed MIME type
[22m[39m{"timestamp":"2026-02-19T09:32:10.922Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"8569103b-fff2-450b-bb29-5e322440e1c2","originalName":"doc.html","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould reject file with disallowed MIME type
[22m[39m{"timestamp":"2026-02-19T09:32:10.922Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"8569103b-fff2-450b-bb29-5e322440e1c2","isClean":false,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":false},{"name":"mime_type_allowlist","passed":false},{"name":"magic_bytes","passed":false}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould throw when scanning non-quarantined entry
[22m[39m{"timestamp":"2026-02-19T09:32:10.923Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"28267548-0d07-4042-9d98-c7c1d9db7a65","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mscan[2m > [22m[2mshould throw when scanning non-quarantined entry
[22m[39m{"timestamp":"2026-02-19T09:32:10.923Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"28267548-0d07-4042-9d98-c7c1d9db7a65","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould promote a clean file
[22m[39m{"timestamp":"2026-02-19T09:32:10.924Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"e6717b95-f13a-41e3-9eda-2e3ee82f47d9","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould promote a clean file
[22m[39m{"timestamp":"2026-02-19T09:32:10.924Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"e6717b95-f13a-41e3-9eda-2e3ee82f47d9","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould promote a clean file
[22m[39m{"timestamp":"2026-02-19T09:32:10.925Z","level":"INFO","message":"File promoted to production","data":{"quarantineId":"e6717b95-f13a-41e3-9eda-2e3ee82f47d9","productionPath":"/production/e6717b95-f13a-41e3-9eda-2e3ee82f47d9/invoice.pdf"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mpromote[2m > [22m[2mshould throw when promoting non-clean file
[22m[39m{"timestamp":"2026-02-19T09:32:10.925Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"5367eafd-2851-4012-be8e-952c0f5035f3","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould reject a quarantined file with reason
[22m[39m{"timestamp":"2026-02-19T09:32:10.926Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"03a0c9e3-8bab-4029-b154-133d0f0c382b","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould reject a quarantined file with reason
[22m[39m{"timestamp":"2026-02-19T09:32:10.927Z","level":"INFO","message":"File rejected","data":{"quarantineId":"03a0c9e3-8bab-4029-b154-133d0f0c382b","reason":"Manual review: suspicious content"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw when rejecting promoted file
[22m[39m{"timestamp":"2026-02-19T09:32:10.930Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"eb846c6f-6585-4190-a2ef-1df4bb99ec10","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw when rejecting promoted file
[22m[39m{"timestamp":"2026-02-19T09:32:10.930Z","level":"INFO","message":"File scan completed","data":{"quarantineId":"eb846c6f-6585-4190-a2ef-1df4bb99ec10","isClean":true,"checks":[{"name":"file_size","passed":true},{"name":"extension_allowlist","passed":true},{"name":"mime_type_allowlist","passed":true},{"name":"magic_bytes","passed":true}]}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw when rejecting promoted file
[22m[39m{"timestamp":"2026-02-19T09:32:10.930Z","level":"INFO","message":"File promoted to production","data":{"quarantineId":"eb846c6f-6585-4190-a2ef-1df4bb99ec10","productionPath":"/production/eb846c6f-6585-4190-a2ef-1df4bb99ec10/invoice.pdf"}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mreject[2m > [22m[2mshould throw on empty reason
[22m[39m{"timestamp":"2026-02-19T09:32:10.931Z","level":"INFO","message":"File quarantined","data":{"quarantineId":"45ebc9e9-441f-44c5-85a0-e689e189aa51","originalName":"invoice.pdf","size":1024}}

[90mstdout[2m | lib/file-quarantine.test.ts[2m > [22m[2mQuarantineService[2m > [22m[2mcleanup[2m > [22m[2mshould clean expired entries
[22m[39m{"timestamp":"2026-02-19T09:32:10.932Z","level":"INFO","message":"Quarantine cleanup completed","data":{"cleaned":1,"total":1}}

 [32mâœ“[39m lib/file-quarantine.test.ts [2m([22m[2m17 tests[22m[2m)[22m[32m 43[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/payments.checkout.route.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 26[2mms[22m[39m
 [32mâœ“[39m lib/gdpr/gdpr.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 36[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/auth.signup.route.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 36[2mms[22m[39m
[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T09:32:11.863Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"e7d9fc38-fd5b-402f-8a06-4f9ca909b440","invoiceId":"inv-001","stepCount":3}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T09:32:11.868Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"e7d9fc38-fd5b-402f-8a06-4f9ca909b440","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T09:32:11.868Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"e7d9fc38-fd5b-402f-8a06-4f9ca909b440","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T09:32:11.869Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"e7d9fc38-fd5b-402f-8a06-4f9ca909b440","step":"extract"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould complete all steps and return success
[22m[39m{"timestamp":"2026-02-19T09:32:11.869Z","level":"INFO","message":"Saga execution completed","data":{"sagaId":"e7d9fc38-fd5b-402f-8a06-4f9ca909b440","result":{"success":true,"completedSteps":["validate","deduct","extract"],"compensatedSteps":[]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T09:32:11.871Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"898d1df8-b32b-40e1-b72b-481ec1fe6544","invoiceId":"inv-001","stepCount":2}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T09:32:11.871Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"898d1df8-b32b-40e1-b72b-481ec1fe6544","step":"setExtraction"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T09:32:11.871Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"898d1df8-b32b-40e1-b72b-481ec1fe6544","step":"checkExtraction"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mhappy path[2m > [22m[2mshould pass shared context through all steps
[22m[39m{"timestamp":"2026-02-19T09:32:11.871Z","level":"INFO","message":"Saga execution completed","data":{"sagaId":"898d1df8-b32b-40e1-b72b-481ec1fe6544","result":{"success":true,"completedSteps":["setExtraction","checkExtraction"],"compensatedSteps":[]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:32:11.873Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"4261c908-1bc6-4e50-b0e5-c879e1182cfb","invoiceId":"inv-001","stepCount":3}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:32:11.873Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"4261c908-1bc6-4e50-b0e5-c879e1182cfb","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:32:11.873Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"4261c908-1bc6-4e50-b0e5-c879e1182cfb","step":"deduct"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:32:11.873Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"4261c908-1bc6-4e50-b0e5-c879e1182cfb","failedStep":"extract","error":"extract execute failed"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:32:11.874Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"4261c908-1bc6-4e50-b0e5-c879e1182cfb","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:32:11.874Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"4261c908-1bc6-4e50-b0e5-c879e1182cfb","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould compensate completed steps in reverse order on failure
[22m[39m{"timestamp":"2026-02-19T09:32:11.874Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"4261c908-1bc6-4e50-b0e5-c879e1182cfb","result":{"success":false,"completedSteps":["validate","deduct"],"failedStep":"extract","compensatedSteps":["deduct","validate"]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.875Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"cfb54efe-8c11-4193-b1d9-c286fb0cd382","invoiceId":"inv-001","stepCount":2}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.875Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"cfb54efe-8c11-4193-b1d9-c286fb0cd382","step":"validate"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.875Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"cfb54efe-8c11-4193-b1d9-c286fb0cd382","failedStep":"failStep","error":"boom"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.875Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"cfb54efe-8c11-4193-b1d9-c286fb0cd382","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould set error on context when a step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.876Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"cfb54efe-8c11-4193-b1d9-c286fb0cd382","result":{"success":false,"completedSteps":["validate"],"failedStep":"failStep","compensatedSteps":["validate"]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould not compensate any steps when the first step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.876Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"93ee0388-3a27-46bf-8d8e-299936d4b3dd","invoiceId":"inv-001","stepCount":2}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould not compensate any steps when the first step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.876Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"93ee0388-3a27-46bf-8d8e-299936d4b3dd","failedStep":"validate","error":"validate execute failed"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mfailure with compensation[2m > [22m[2mshould not compensate any steps when the first step fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.876Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"93ee0388-3a27-46bf-8d8e-299936d4b3dd","result":{"success":false,"completedSteps":[],"failedStep":"validate","compensatedSteps":[]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.877Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","invoiceId":"inv-001","stepCount":4}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.877Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","step":"extract"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"ERROR","message":"Saga step failed â€” starting compensation","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","failedStep":"convert","error":"convert execute failed"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","step":"extract"}}

[90mstderr[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"ERROR","message":"Saga compensation failed","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","step":"deduct","error":"deduct compensate failed"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"INFO","message":"Saga compensation completed","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mpartial compensation on double failure[2m > [22m[2mshould continue compensating remaining steps even if one compensation fails
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"INFO","message":"Saga execution failed","data":{"sagaId":"afaff6c0-4899-4d50-a6ea-ca56a79bb2b2","result":{"success":false,"completedSteps":["validate","deduct","extract"],"failedStep":"convert","compensatedSteps":["extract","validate"]}}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T09:32:11.879Z","level":"INFO","message":"Saga execution started","data":{"sagaId":"9db69ff8-d3a4-4d1b-9234-b6a404ff9458","invoiceId":"inv-001","stepCount":2}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T09:32:11.879Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"9db69ff8-d3a4-4d1b-9234-b6a404ff9458","step":"validate"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T09:32:11.880Z","level":"INFO","message":"Saga step completed","data":{"sagaId":"9db69ff8-d3a4-4d1b-9234-b6a404ff9458","step":"deduct"}}

[90mstdout[2m | lib/saga/orchestrator.test.ts[2m > [22m[2mSagaOrchestrator[2m > [22m[2mlog writer[2m > [22m[2mshould call log writer for each step execution
[22m[39m{"timestamp":"2026-02-19T09:32:11.880Z","level":"INFO","message":"Saga execution completed","data":{"sagaId":"9db69ff8-d3a4-4d1b-9234-b6a404ff9458","result":{"success":true,"completedSteps":["validate","deduct"],"compensatedSteps":[]}}}

 [32mâœ“[39m lib/saga/orchestrator.test.ts [2m([22m[2m9 tests[22m[2m)[22m[32m 26[2mms[22m[39m
[90mstdout[2m | lib/feature-flags/feature-flags.test.ts[2m > [22m[2mFeatureFlagService[2m > [22m[2msetFlag[2m > [22m[2mupdates flag and invalidates cache
[22m[39m{"timestamp":"2026-02-19T09:32:11.878Z","level":"INFO","message":"Feature flag updated","data":{"flagId":"toggle","enabled":false}}

[90mstderr[2m | lib/feature-flags/feature-flags.test.ts[2m > [22m[2mFeatureFlagService[2m > [22m[2merror handling[2m > [22m[2mreturns false when DB query fails (fail closed)
[22m[39m{"timestamp":"2026-02-19T09:32:11.889Z","level":"ERROR","message":"Failed to evaluate feature flag","data":{"flagId":"any_flag","error":{"code":"FEATURE_FLAG_LOAD_FAILED","statusCode":500,"name":"AppError"}}}

 [32mâœ“[39m lib/feature-flags/feature-flags.test.ts [2m([22m[2m20 tests[22m[2m)[22m[32m 35[2mms[22m[39m
[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mgenerates valid UBL 2.1 XML
[22m[39m{"timestamp":"2026-02-19T09:32:12.259Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.265Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhas correct PEPPOL CustomizationID
[22m[39m{"timestamp":"2026-02-19T09:32:12.266Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.266Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mdoes NOT contain XRechnung CustomizationID
[22m[39m{"timestamp":"2026-02-19T09:32:12.267Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.267Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhas correct ProfileID
[22m[39m{"timestamp":"2026-02-19T09:32:12.267Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.267Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mdoes NOT include Leitweg-ID
[22m[39m{"timestamp":"2026-02-19T09:32:12.268Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.268Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles non-EUR currency (SEK)
[22m[39m{"timestamp":"2026-02-19T09:32:12.269Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.269Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles GBP currency
[22m[39m{"timestamp":"2026-02-19T09:32:12.269Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.269Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles NOK currency
[22m[39m{"timestamp":"2026-02-19T09:32:12.270Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.270Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles DKK currency
[22m[39m{"timestamp":"2026-02-19T09:32:12.270Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.271Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mincludes EndpointID elements
[22m[39m{"timestamp":"2026-02-19T09:32:12.271Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.271Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mincludes required elements: InvoiceNumber, IssueDate, Currency
[22m[39m{"timestamp":"2026-02-19T09:32:12.272Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.272Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mincludes line items
[22m[39m{"timestamp":"2026-02-19T09:32:12.272Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.272Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mgenerates credit notes (TypeCode 381) correctly
[22m[39m{"timestamp":"2026-02-19T09:32:12.273Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.273Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mgenerates correct filename with _peppol suffix
[22m[39m{"timestamp":"2026-02-19T09:32:12.273Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.273Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mreports correct file size
[22m[39m{"timestamp":"2026-02-19T09:32:12.274Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.274Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mhandles allowances/charges
[22m[39m{"timestamp":"2026-02-19T09:32:12.274Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.274Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPeppolBISGenerator[2m > [22m[2mvalidate()[2m > [22m[2mpasses for valid PEPPOL XML
[22m[39m{"timestamp":"2026-02-19T09:32:12.275Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"PEPP-2024-001"}}
{"timestamp":"2026-02-19T09:32:12.275Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPEPPOL BIS factory registration[2m > [22m[2mGeneratorFactory.create("peppol-bis") returns PeppolBISGenerator
[22m[39m{"timestamp":"2026-02-19T09:32:12.282Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}

[90mstdout[2m | tests/unit/peppol-bis.test.ts[2m > [22m[2mPEPPOL BIS factory registration[2m > [22m[2mreturns cached singleton for peppol-bis
[22m[39m{"timestamp":"2026-02-19T09:32:12.283Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}

 [32mâœ“[39m tests/unit/peppol-bis.test.ts [2m([22m[2m35 tests[22m[2m)[22m[32m 28[2mms[22m[39m
[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mcreateApiKey[2m > [22m[2mshould create a key and return it once
[22m[39m{"timestamp":"2026-02-19T09:32:12.463Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"63bb615e-67a3-4160-9f60-f4da969596e7"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mvalidateApiKey[2m > [22m[2mshould validate a correctly created key
[22m[39m{"timestamp":"2026-02-19T09:32:12.471Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"c8642933-fbea-4f85-976b-514d3e1c7e36"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mvalidateApiKey[2m > [22m[2mshould reject expired key
[22m[39m{"timestamp":"2026-02-19T09:32:12.472Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"10a0e7f7-6527-4531-aacd-a108c39c75e7"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mvalidateApiKey[2m > [22m[2mshould reject expired key
[22m[39m{"timestamp":"2026-02-19T09:32:12.473Z","level":"INFO","message":"API key expired","data":{"keyId":"10a0e7f7-6527-4531-aacd-a108c39c75e7"}}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: xrechnung-cii
[22m[39m{"timestamp":"2026-02-19T09:32:12.466Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrevokeKey[2m > [22m[2mshould revoke an existing key
[22m[39m{"timestamp":"2026-02-19T09:32:12.473Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"c882e0ca-e570-49ef-a9d0-acf59fcdb861"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrevokeKey[2m > [22m[2mshould revoke an existing key
[22m[39m{"timestamp":"2026-02-19T09:32:12.473Z","level":"INFO","message":"API key revoked","data":{"keyId":"c882e0ca-e570-49ef-a9d0-acf59fcdb861","userId":"550e8400-e29b-41d4-a716-446655440000"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mlistKeys[2m > [22m[2mshould list keys without exposing raw keys
[22m[39m{"timestamp":"2026-02-19T09:32:12.474Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"04b95695-c97f-428f-9ee1-c8718aa0522c"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mlistKeys[2m > [22m[2mshould list keys without exposing raw keys
[22m[39m{"timestamp":"2026-02-19T09:32:12.474Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"2ac6ecbb-f53f-4b4c-9e15-e8a85f1ad68a"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrotateKey[2m > [22m[2mshould revoke old key and create new one with same scopes
[22m[39m{"timestamp":"2026-02-19T09:32:12.476Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"36d297d1-f700-4cab-83b0-cf997363339b"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrotateKey[2m > [22m[2mshould revoke old key and create new one with same scopes
[22m[39m{"timestamp":"2026-02-19T09:32:12.476Z","level":"INFO","message":"API key revoked","data":{"keyId":"36d297d1-f700-4cab-83b0-cf997363339b","userId":"550e8400-e29b-41d4-a716-446655440000"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mrotateKey[2m > [22m[2mshould revoke old key and create new one with same scopes
[22m[39m{"timestamp":"2026-02-19T09:32:12.476Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"f40602f1-fbb4-4683-8ae3-c075a959b43e"}}

[90mstdout[2m | lib/api-keys/api-keys.test.ts[2m > [22m[2mApiKeyService[2m > [22m[2mscope checking[2m > [22m[2mshould correctly validate scopes on created key
[22m[39m{"timestamp":"2026-02-19T09:32:12.477Z","level":"INFO","message":"API key created","data":{"userId":"550e8400-e29b-41d4-a716-446655440000","keyId":"180b2951-5cec-4765-98d3-6de3696b74ee"}}

 [32mâœ“[39m lib/api-keys/api-keys.test.ts [2m([22m[2m23 tests[22m[2m)[22m[32m 24[2mms[22m[39m
[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: xrechnung-ubl
[22m[39m{"timestamp":"2026-02-19T09:32:12.479Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}
{"timestamp":"2026-02-19T09:32:12.479Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RT-2024-042"}}
{"timestamp":"2026-02-19T09:32:12.481Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: peppol-bis
[22m[39m{"timestamp":"2026-02-19T09:32:12.483Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}
{"timestamp":"2026-02-19T09:32:12.483Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RT-2024-042"}}
{"timestamp":"2026-02-19T09:32:12.483Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: fatturapa
[22m[39m{"timestamp":"2026-02-19T09:32:12.485Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/round-trip.test.ts[2m > [22m[2mRound-Trip Validation[2m > [22m[2mformat: ksef
[22m[39m{"timestamp":"2026-02-19T09:32:12.487Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

 [32mâœ“[39m tests/unit/round-trip.test.ts [2m([22m[2m35 tests[22m[2m)[22m[32m 26[2mms[22m[39m
[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "ignore previous instructions"
[22m[39m{"timestamp":"2026-02-19T09:32:12.490Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "disregard prior rules"
[22m[39m{"timestamp":"2026-02-19T09:32:12.498Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "forget previous prompts"
[22m[39m{"timestamp":"2026-02-19T09:32:12.498Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "override earlier rules"
[22m[39m{"timestamp":"2026-02-19T09:32:12.498Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "you are now a" role hijack
[22m[39m{"timestamp":"2026-02-19T09:32:12.499Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "act as if" role hijack
[22m[39m{"timestamp":"2026-02-19T09:32:12.499Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "pretend to be" role hijack
[22m[39m{"timestamp":"2026-02-19T09:32:12.499Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs "switch to X mode"
[22m[39m{"timestamp":"2026-02-19T09:32:12.500Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs system prompt reveal attempts
[22m[39m{"timestamp":"2026-02-19T09:32:12.500Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.500Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.500Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.501Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs LLM format markers [INST]
[22m[39m{"timestamp":"2026-02-19T09:32:12.501Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":2,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs Llama format markers <<SYS>>
[22m[39m{"timestamp":"2026-02-19T09:32:12.501Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":2,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs ChatML format markers
[22m[39m{"timestamp":"2026-02-19T09:32:12.502Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":2,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs role markers at line start
[22m[39m{"timestamp":"2026-02-19T09:32:12.502Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.502Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.502Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mdefangs output manipulation patterns
[22m[39m{"timestamp":"2026-02-19T09:32:12.502Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.502Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.502Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}
{"timestamp":"2026-02-19T09:32:12.503Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mhandles case-insensitive injection patterns
[22m[39m{"timestamp":"2026-02-19T09:32:12.503Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mhandles multi-vector attack combining invisible chars + injection
[22m[39m{"timestamp":"2026-02-19T09:32:12.504Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

[90mstderr[2m | tests/unit/ai-sanitization.test.ts[2m > [22m[2msanitizeDocumentContent[2m > [22m[2mhandles injection hidden across lines
[22m[39m{"timestamp":"2026-02-19T09:32:12.504Z","level":"WARN","message":"Prompt injection patterns detected and defanged in document content","data":{"injectionCount":1,"audit":"Re-audit #7"}}

 [32mâœ“[39m tests/unit/ai-sanitization.test.ts [2m([22m[2m40 tests[22m[2m)[22m[32m 27[2mms[22m[39m
 [32mâœ“[39m lib/metrics.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 25[2mms[22m[39m
 [32mâœ“[39m lib/retention/retention.test.ts [2m([22m[2m26 tests[22m[2m)[22m[32m 24[2mms[22m[39m
[90mstderr[2m | lib/state-machine/invoice-machine.test.ts[2m > [22m[2mgetNextStates[2m > [22m[2mshould return empty array from ARCHIVED
[22m[39mEvent "UPLOAD" was sent to stopped actor "x:47 (x:47)". This actor has already reached its final state, and will not transition.
Event: {"type":"UPLOAD"}
Event "QUARANTINE" was sent to stopped actor "x:48 (x:48)". This actor has already reached its final state, and will not transition.
Event: {"type":"QUARANTINE"}
Event "SCAN_PASS" was sent to stopped actor "x:49 (x:49)". This actor has already reached its final state, and will not transition.
Event: {"type":"SCAN_PASS"}
Event "SCAN_FAIL" was sent to stopped actor "x:50 (x:50)". This actor has already reached its final state, and will not transition.
Event: {"type":"SCAN_FAIL"}
Event "EXTRACT" was sent to stopped actor "x:51 (x:51)". This actor has already reached its final state, and will not transition.
Event: {"type":"EXTRACT"}
Event "EXTRACT_SUCCESS" was sent to stopped actor "x:52 (x:52)". This actor has already reached its final state, and will not transition.
Event: {"type":"EXTRACT_SUCCESS"}
Event "EXTRACT_FAIL" was sent to stopped actor "x:53 (x:53)". This actor has already reached its final state, and will not transition.
Event: {"type":"EXTRACT_FAIL"}
Event "APPROVE" was sent to stopped actor "x:54 (x:54)". This actor has already reached its final state, and will not transition.
Event: {"type":"APPROVE"}
Event "CONVERT" was sent to stopped actor "x:55 (x:55)". This actor has already reached its final state, and will not transition.
Event: {"type":"CONVERT"}
Event "CONVERT_SUCCESS" was sent to stopped actor "x:56 (x:56)". This actor has already reached its final state, and will not transition.
Event: {"type":"CONVERT_SUCCESS"}
Event "CONVERT_FAIL" was sent to stopped actor "x:57 (x:57)". This actor has already reached its final state, and will not transition.
Event: {"type":"CONVERT_FAIL"}
Event "ARCHIVE" was sent to stopped actor "x:58 (x:58)". This actor has already reached its final state, and will not transition.
Event: {"type":"ARCHIVE"}
Event "RETRY" was sent to stopped actor "x:59 (x:59)". This actor has already reached its final state, and will not transition.
Event: {"type":"RETRY"}

 [32mâœ“[39m lib/state-machine/invoice-machine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[32m 25[2mms[22m[39m
[90mstderr[2m | tests/unit/external-validation.test.ts[2m > [22m[2mXRechnungValidator.validateExternal[2m > [22m[2mshould return error when JAR path is not set
[22m[39m{"timestamp":"2026-02-19T09:32:12.838Z","level":"WARN","message":"External validation enabled but KOSIT_VALIDATOR_JAR not found","data":{"jarPath":""}}

[90mstderr[2m | tests/unit/external-validation.test.ts[2m > [22m[2mXRechnungValidator.validateExternal[2m > [22m[2mshould return error when JAR file does not exist
[22m[39m{"timestamp":"2026-02-19T09:32:12.844Z","level":"WARN","message":"External validation enabled but KOSIT_VALIDATOR_JAR not found","data":{"jarPath":"/nonexistent/validator.jar"}}

[90mstderr[2m | tests/unit/external-validation.test.ts[2m > [22m[2mXRechnungValidator.validateExternal[2m > [22m[2mshould return error when scenarios XML is missing
[22m[39m{"timestamp":"2026-02-19T09:32:12.849Z","level":"WARN","message":"External validation enabled but KOSIT_SCENARIOS_XML not found","data":{"scenariosPath":""}}

 [32mâœ“[39m tests/unit/external-validation.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 24[2mms[22m[39m
[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould generate XML with NLCIUS customization ID
[22m[39m{"timestamp":"2026-02-19T09:32:14.696Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.702Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould NOT contain PEPPOL customization ID
[22m[39m{"timestamp":"2026-02-19T09:32:14.703Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.703Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould generate valid UBL XML structure
[22m[39m{"timestamp":"2026-02-19T09:32:14.704Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.704Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould produce _nlcius file name
[22m[39m{"timestamp":"2026-02-19T09:32:14.705Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.705Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUSGenerator[2m > [22m[2mshould set fileSize correctly
[22m[39m{"timestamp":"2026-02-19T09:32:14.705Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.706Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Additional Coverage[2m > [22m[2mhandles credit note (documentTypeCode 381)
[22m[39m{"timestamp":"2026-02-19T09:32:14.710Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.710Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Additional Coverage[2m > [22m[2mhandles non-EUR currency (USD)
[22m[39m{"timestamp":"2026-02-19T09:32:14.711Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.711Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Additional Coverage[2m > [22m[2mhandles missing endpoint IDs without crashing
[22m[39m{"timestamp":"2026-02-19T09:32:14.711Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"NL-2024-001"}}
{"timestamp":"2026-02-19T09:32:14.711Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/nlcius.test.ts[2m > [22m[2mNLCIUS Factory Registration[2m > [22m[2mshould be available via GeneratorFactory
[22m[39m{"timestamp":"2026-02-19T09:32:14.712Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}

 [32mâœ“[39m tests/unit/nlcius.test.ts [2m([22m[2m20 tests[22m[2m)[22m[32m 21[2mms[22m[39m
 [32mâœ“[39m lib/container/container.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 29[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/stripe.adapter.test.ts[2m > [22m[2mStripeAdapter[2m > [22m[2mshould construct webhook event verification
[22m[39m{"timestamp":"2026-02-19T09:32:15.468Z","level":"INFO","message":"Stripe webhook signature verified successfully"}

[90mstdout[2m | tests/unit/adapters/stripe.adapter.test.ts[2m > [22m[2mStripeAdapter[2m > [22m[2mshould refund payment
[22m[39m{"timestamp":"2026-02-19T09:32:15.480Z","level":"INFO","message":"Stripe refund successful","data":{"refundId":"re_123","paymentIntentId":"pi_123","amount":1000,"status":"succeeded"}}

[90mstderr[2m | tests/unit/adapters/stripe.adapter.test.ts[2m > [22m[2mStripeAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T09:32:15.482Z","level":"ERROR","message":"Stripe checkout session creation failed","data":{"error":"Error message"}}

 [32mâœ“[39m tests/unit/adapters/stripe.adapter.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 29[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/auth.logout.route.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 21[2mms[22m[39m
[90mstdout[2m | tests/unit/ksef.test.ts[2m > [22m[2mKSeF Factory Integration[2m > [22m[2mshould create ksef generator via factory
[22m[39m{"timestamp":"2026-02-19T09:32:15.890Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

 [32mâœ“[39m tests/unit/ksef.test.ts [2m([22m[2m36 tests[22m[2m)[22m[32m 22[2mms[22m[39m
[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUSROGenerator[2m > [22m[2mshould generate XML with CIUS-RO customization ID
[22m[39m{"timestamp":"2026-02-19T09:32:16.345Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T09:32:16.352Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUSROGenerator[2m > [22m[2mshould NOT contain PEPPOL customization ID
[22m[39m{"timestamp":"2026-02-19T09:32:16.353Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T09:32:16.353Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUSROGenerator[2m > [22m[2mshould produce _ciusro file name
[22m[39m{"timestamp":"2026-02-19T09:32:16.354Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T09:32:16.354Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Additional Coverage[2m > [22m[2mhandles credit note (documentTypeCode 381)
[22m[39m{"timestamp":"2026-02-19T09:32:16.358Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T09:32:16.359Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Additional Coverage[2m > [22m[2mhandles non-RON currency (EUR)
[22m[39m{"timestamp":"2026-02-19T09:32:16.359Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T09:32:16.359Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Additional Coverage[2m > [22m[2mhandles missing endpoint IDs without crashing
[22m[39m{"timestamp":"2026-02-19T09:32:16.360Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"RO-2024-001"}}
{"timestamp":"2026-02-19T09:32:16.360Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/ciusro.test.ts[2m > [22m[2mCIUS-RO Factory Registration[2m > [22m[2mshould be available via GeneratorFactory
[22m[39m{"timestamp":"2026-02-19T09:32:16.361Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}

 [32mâœ“[39m tests/unit/ciusro.test.ts [2m([22m[2m17 tests[22m[2m)[22m[32m 20[2mms[22m[39m
[90mstdout[2m | tests/unit/fatturapa.test.ts[2m > [22m[2mFatturaPA Factory Integration[2m > [22m[2mGeneratorFactory.create("fatturapa") works
[22m[39m{"timestamp":"2026-02-19T09:32:16.442Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

 [32mâœ“[39m tests/unit/fatturapa.test.ts [2m([22m[2m30 tests[22m[2m)[22m[32m 23[2mms[22m[39m
[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2msanitizeXml[2m > [22m[2mshould strip simple DOCTYPE declarations
[22m[39m{"timestamp":"2026-02-19T09:32:16.558Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2msanitizeXml[2m > [22m[2mshould throw on SYSTEM entity (XXE)
[22m[39m{"timestamp":"2026-02-19T09:32:16.563Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}
{"timestamp":"2026-02-19T09:32:16.564Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2msanitizeXml[2m > [22m[2mshould throw on PUBLIC entity (XXE)
[22m[39m{"timestamp":"2026-02-19T09:32:16.565Z","level":"WARN","message":"xml-security: External entity pattern detected â€” rejecting XML"}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2mparseXmlSafe[2m > [22m[2mshould throw on XXE attack
[22m[39m{"timestamp":"2026-02-19T09:32:16.572Z","level":"WARN","message":"xml-security: parseXmlSafe rejected XML","data":{"code":"DOCTYPE_REJECTED","reason":"XML contains a DOCTYPE declaration â€” DTDs are not allowed"}}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2mparseXmlSafe[2m > [22m[2mshould throw on billion laughs (excessive entities)
[22m[39m{"timestamp":"2026-02-19T09:32:16.572Z","level":"WARN","message":"xml-security: parseXmlSafe rejected XML","data":{"code":"ENTITY_EXPANSION_LIMIT","reason":"XML contains 600 entity references (limit: 500) â€” possible billion laughs attack"}}

[90mstderr[2m | lib/xml-security.test.ts[2m > [22m[2mparseXmlSafe[2m > [22m[2mshould throw on oversized XML
[22m[39m{"timestamp":"2026-02-19T09:32:16.573Z","level":"WARN","message":"xml-security: parseXmlSafe rejected XML","data":{"code":"XML_TOO_LARGE","reason":"XML size 1037 bytes exceeds limit of 100 bytes"}}

 [32mâœ“[39m lib/xml-security.test.ts [2m([22m[2m28 tests[22m[2m)[22m[32m 20[2mms[22m[39m
[90mstderr[2m | tests/unit/adapters/sendgrid.adapter.test.ts[2m > [22m[2mSendGridAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T09:32:16.661Z","level":"ERROR","message":"SendGrid API error","data":{"status":400,"body":"Bad Request"}}

[90mstderr[2m | tests/unit/adapters/sendgrid.adapter.test.ts[2m > [22m[2mSendGridAdapter[2m > [22m[2mshould handle configuration error
[22m[39m{"timestamp":"2026-02-19T09:32:16.668Z","level":"WARN","message":"SendGrid not configured"}

 [32mâœ“[39m tests/unit/adapters/sendgrid.adapter.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/auth.me.route.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 20[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/admin.user.detail.route.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 22[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T09:32:16.721Z","level":"INFO","message":"Gemini extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T09:32:16.726Z","level":"INFO","message":"Gemini extraction successful","data":{"processingTimeMs":6,"confidence":0.7}}

[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T09:32:16.727Z","level":"INFO","message":"Gemini extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstderr[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T09:32:16.728Z","level":"WARN","message":"Gemini response parse failed","data":{"responseLength":12}}
{"timestamp":"2026-02-19T09:32:16.728Z","level":"ERROR","message":"Gemini extraction failed","data":{"message":"Failed to parse Gemini response"}}
{"timestamp":"2026-02-19T09:32:16.728Z","level":"WARN","message":"Gemini extraction failure context","data":{"responseTime":1,"errorType":"AppError"}}

[90mstdout[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T09:32:16.729Z","level":"INFO","message":"Gemini extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstderr[2m | tests/unit/adapters/gemini.adapter.test.ts[2m > [22m[2mGeminiAdapter[2m > [22m[2mshould handle API errors
[22m[39m{"timestamp":"2026-02-19T09:32:16.730Z","level":"ERROR","message":"Gemini extraction failed","data":{"message":"API Error"}}
{"timestamp":"2026-02-19T09:32:16.730Z","level":"WARN","message":"Gemini extraction failure context","data":{"responseTime":1,"errorType":"Error"}}

 [32mâœ“[39m tests/unit/adapters/gemini.adapter.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 15[2mms[22m[39m
[90mstderr[2m | lib/rbac/rbac.test.ts[2m > [22m[2mUnknown Role[2m > [22m[2mshould have no permissions
[22m[39m{"timestamp":"2026-02-19T09:32:16.800Z","level":"ERROR","message":"Unknown role encountered in RBAC ability builder","data":{"role":"unknown","userId":"unknown-1"}}

 [32mâœ“[39m lib/rbac/rbac.test.ts [2m([22m[2m26 tests[22m[2m)[22m[32m 17[2mms[22m[39m
[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T09:32:16.806Z","level":"INFO","message":"OpenAI extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould extract invoice data successfully
[22m[39m{"timestamp":"2026-02-19T09:32:16.812Z","level":"INFO","message":"OpenAI extraction successful","data":{"processingTimeMs":6,"confidence":0.7}}

[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle API timeouts
[22m[39m{"timestamp":"2026-02-19T09:32:16.814Z","level":"INFO","message":"OpenAI extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstderr[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle API timeouts
[22m[39m{"timestamp":"2026-02-19T09:32:16.815Z","level":"ERROR","message":"OpenAI API timeout","data":{"processingTimeMs":1}}

[90mstdout[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T09:32:16.818Z","level":"INFO","message":"OpenAI extraction started","data":{"mimeType":"application/pdf","bufferSize":4}}

[90mstderr[2m | tests/unit/adapters/openai.adapter.test.ts[2m > [22m[2mOpenAIAdapter[2m > [22m[2mshould handle invalid JSON response
[22m[39m{"timestamp":"2026-02-19T09:32:16.818Z","level":"ERROR","message":"JSON parsing failed","data":{"responseLength":12}}
{"timestamp":"2026-02-19T09:32:16.818Z","level":"ERROR","message":"OpenAI extraction failed","data":{"processingTimeMs":0,"errorMessage":"Invalid JSON response from OpenAI"}}

 [32mâœ“[39m tests/unit/adapters/openai.adapter.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 17[2mms[22m[39m
[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mGenerated XML â€” canonical identifiers[2m > [22m[2mcontains the PEPPOL BIS 3.0 CustomizationID
[22m[39m{"timestamp":"2026-02-19T09:32:16.965Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"TEST-PEPPOL-3020"}}
{"timestamp":"2026-02-19T09:32:16.971Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mGenerated XML â€” canonical identifiers[2m > [22m[2mcontains the PEPPOL BIS 3.0 ProfileID
[22m[39m{"timestamp":"2026-02-19T09:32:16.972Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"TEST-PEPPOL-3020"}}
{"timestamp":"2026-02-19T09:32:16.972Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mGenerated XML â€” canonical identifiers[2m > [22m[2mcontains EndpointID for seller (BT-34)
[22m[39m{"timestamp":"2026-02-19T09:32:16.972Z","level":"INFO","message":"Generating UBL 2.1 XRechnung invoice","data":{"invoiceNumber":"TEST-PEPPOL-3020"}}
{"timestamp":"2026-02-19T09:32:16.972Z","level":"INFO","message":"UBL XRechnung invoice generated successfully"}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mxrechnung-cii has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.976Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mxrechnung-ubl has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.976Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mpeppol-bis has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.977Z","level":"INFO","message":"Format generator created","data":{"format":"peppol-bis","name":"PEPPOL BIS Billing 3.0"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mfacturx-en16931 has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.977Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-en16931","name":"Factur-X EN 16931 (Comfort)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mfacturx-basic has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.977Z","level":"INFO","message":"Format generator created","data":{"format":"facturx-basic","name":"Factur-X Basic"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mfatturapa has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.978Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mksef has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.978Z","level":"INFO","message":"Format generator created","data":{"format":"ksef","name":"KSeF FA(2) â€” Poland"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mnlcius has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.978Z","level":"INFO","message":"Format generator created","data":{"format":"nlcius","name":"NLCIUS / SI-UBL 2.0 (Netherlands)"}}

[90mstdout[2m | tests/unit/peppol-v3020.test.ts[2m > [22m[2mPeppol BIS Billing 3.0 v3.0.20 compliance[2m > [22m[2mAll generators implement specVersion and specDate[2m > [22m[2mcius-ro has a non-empty specVersion and specDate
[22m[39m{"timestamp":"2026-02-19T09:32:16.979Z","level":"INFO","message":"Format generator created","data":{"format":"cius-ro","name":"CIUS-RO (Romania)"}}

 [32mâœ“[39m tests/unit/peppol-v3020.test.ts [2m([22m[2m23 tests[22m[2m)[22m[32m 18[2mms[22m[39m
 [32mâœ“[39m tests/unit/review.service.test.ts [2m([22m[2m38 tests[22m[2m)[22m[32m 17[2mms[22m[39m
 [32mâœ“[39m lib/outbox/outbox.test.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 15[2mms[22m[39m
[90mstderr[2m | tests/unit/xml-utils.test.ts[2m > [22m[2mformatDateISO[2m > [22m[2mrejects ambiguous slash formats
[22m[39m{"timestamp":"2026-02-19T09:32:19.271Z","level":"WARN","message":"xml-utils: Ambiguous date format rejected","data":{"date":"01/02/2024"}}

[90mstderr[2m | tests/unit/xml-utils.test.ts[2m > [22m[2mformatDateCII[2m > [22m[2mrejects ambiguous slash formats
[22m[39m{"timestamp":"2026-02-19T09:32:19.276Z","level":"WARN","message":"xml-utils: Ambiguous date format rejected","data":{"date":"01/02/2024"}}

 [32mâœ“[39m tests/unit/xml-utils.test.ts [2m([22m[2m24 tests[22m[2m)[22m[32m 14[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/health.route.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 14[2mms[22m[39m
 [32mâœ“[39m tests/unit/ai/extractors.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/handleApiError.test.ts [2m([22m[2m10 tests[22m[2m)[22m[32m 15[2mms[22m[39m
 [32mâœ“[39m tests/unit/routes/packages.route.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 13[2mms[22m[39m
 [32mâœ“[39m tests/unit/readiness-panel-logic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 13[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/api-throttle.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m lib/encryption/envelope.test.ts [2m([22m[2m17 tests[22m[2m)[22m[32m 14[2mms[22m[39m
 [32mâœ“[39m tests/unit/validation-pipeline.test.ts [2m([22m[2m24 tests[22m[2m)[22m[32m 13[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mreturns hasText: true for digital PDFs with sufficient text
[22m[39m{"timestamp":"2026-02-19T09:32:20.948Z","level":"INFO","message":"PDF text extraction complete","data":{"pageCount":1,"textLength":200,"avgCharsPerPage":200,"hasText":true}}

[90mstdout[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mjoins multiple pages with double newline
[22m[39m{"timestamp":"2026-02-19T09:32:20.955Z","level":"INFO","message":"PDF text extraction complete","data":{"pageCount":2,"textLength":202,"avgCharsPerPage":101,"hasText":true}}

[90mstdout[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mreturns hasText: false for scanned PDFs with little text
[22m[39m{"timestamp":"2026-02-19T09:32:20.956Z","level":"INFO","message":"PDF text extraction complete","data":{"pageCount":1,"textLength":2,"avgCharsPerPage":2,"hasText":false}}

[90mstderr[2m | tests/unit/lib/pdf-text-extractor.test.ts[2m > [22m[2mextractTextFromPdf[2m > [22m[2mreturns hasText: false on parse error
[22m[39m{"timestamp":"2026-02-19T09:32:20.957Z","level":"WARN","message":"PDF text extraction failed, treating as scanned","data":{"error":"corrupt PDF"}}

 [32mâœ“[39m tests/unit/lib/pdf-text-extractor.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 14[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-normalizer-prompt-contract.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 12[2mms[22m[39m
[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mprocessPayment throws for invalid package
[22m[39m{"timestamp":"2026-02-19T09:32:21.071Z","level":"INFO","message":"Processing payment","data":{"method":"stripe","userId":"user-1","packageId":"invalid_pkg"}}

[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mprocessPayment creates stripe session when configured
[22m[39m{"timestamp":"2026-02-19T09:32:21.078Z","level":"INFO","message":"Processing payment","data":{"method":"stripe","userId":"user-1","packageId":"basic_10"}}

[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mhandleStripeWebhook returns already processed when event exists
[22m[39m{"timestamp":"2026-02-19T09:32:21.081Z","level":"INFO","message":"Handling Stripe webhook","data":{"type":"checkout.session.completed","eventId":"evt_1"}}

[90mstdout[2m | tests/unit/payment-processor.test.ts[2m > [22m[2mPaymentProcessor[2m > [22m[2mhandleStripeWebhook returns already processed when event exists
[22m[39m{"timestamp":"2026-02-19T09:32:21.081Z","level":"INFO","message":"Webhook already processed, skipping","data":{"eventId":"evt_1"}}

 [32mâœ“[39m tests/unit/payment-processor.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 13[2mms[22m[39m
[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mcreates xrechnung-cii generator
[22m[39m{"timestamp":"2026-02-19T09:32:21.222Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mcreates xrechnung-ubl generator
[22m[39m{"timestamp":"2026-02-19T09:32:21.228Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mreturns cached singleton instances
[22m[39m{"timestamp":"2026-02-19T09:32:21.229Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mreturns different instances for different formats
[22m[39m{"timestamp":"2026-02-19T09:32:21.229Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}
{"timestamp":"2026-02-19T09:32:21.229Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-ubl","name":"XRechnung 3.0 (UBL)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mcreates fatturapa generator
[22m[39m{"timestamp":"2026-02-19T09:32:21.230Z","level":"INFO","message":"Format generator created","data":{"format":"fatturapa","name":"FatturaPA 1.2 (Italy)"}}

[90mstdout[2m | tests/unit/GeneratorFactory.test.ts[2m > [22m[2mGeneratorFactory[2m > [22m[2mclear resets the cache
[22m[39m{"timestamp":"2026-02-19T09:32:21.232Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}
{"timestamp":"2026-02-19T09:32:21.232Z","level":"INFO","message":"Format generator created","data":{"format":"xrechnung-cii","name":"XRechnung 3.0 (CII)"}}

 [32mâœ“[39m tests/unit/GeneratorFactory.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 14[2mms[22m[39m
[90mstderr[2m | tests/unit/lib/extraction-normalizer-safe-number.test.ts[2m > [22m[2mnormalizeExtractedData â€” monetary fields with locale formats[2m > [22m[2mdefaults totalAmount to 0 when completely unparseable (not silent NaNâ†’0)
[22m[39m{"timestamp":"2026-02-19T09:32:21.803Z","level":"WARN","message":"totalAmount is not a valid number, defaulting to 0","data":{"raw":"N/A"}}

 [32mâœ“[39m tests/unit/lib/extraction-normalizer-safe-number.test.ts [2m([22m[2m18 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m tests/unit/auth.service.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m tests/unit/boundary-detection.service.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 11[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/api-helpers.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 12[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/utils.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 11[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-normalizer-en16931.test.ts [2m([22m[2m29 tests[22m[2m)[22m[32m 11[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/extraction-normalizer-taxrate-array.test.ts[2m > [22m[2mextraction-normalizer: taxRate array handling[2m > [22m[2mshould convert line item taxRate array to undefined
[22m[39m{"timestamp":"2026-02-19T09:32:24.578Z","level":"INFO","message":"Gross pricing detected â€” converting line items and allowances to NET","data":{"lineTotal":100,"totalAmount":100,"taxAmount":100}}

[90mstdout[2m | tests/unit/lib/extraction-normalizer-taxrate-array.test.ts[2m > [22m[2mextraction-normalizer: taxRate array handling[2m > [22m[2mshould preserve normal line item taxRate
[22m[39m{"timestamp":"2026-02-19T09:32:24.584Z","level":"INFO","message":"Gross pricing detected â€” converting line items and allowances to NET","data":{"lineTotal":100,"totalAmount":100,"taxAmount":100}}

 [32mâœ“[39m tests/unit/lib/extraction-normalizer-taxrate-array.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 11[2mms[22m[39m
[2m10:32:24[22m [33m[1m[vite][22m[39m [33m[2m(client)[22m[39m [33mwarning: [33mDuplicate key "createAdminClient" in object literal[33m
50 |  vi.mock('@/lib/supabase.server', () => ({
51 |    createAdminClient: vi.fn(() => mockChain),
52 |    createAdminClient: vi.fn(() => mockChain),
   |    ^
53 |    createUserScopedClient: vi.fn(() => Promise.resolve(mockChain)),
54 |  }));
[39m
  Plugin: [35mvite:esbuild[39m
  File: [36mC:/Users/osama/Desktop/Invoice2E.1/tests/unit/batch/credit-idempotency.test.ts[39m
 [32mâœ“[39m tests/unit/admin/transaction.admin.service.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/format-registry.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/canonical-mapper.test.ts [2m([22m[2m15 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/batch/credit-idempotency.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/monetary-validator.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/ocr-extractor.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/session.test.ts [2m([22m[2m18 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/queue/workers-shutdown.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/batch-format-validation.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m lib/circuit-breaker.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/adapters/paypal.adapter.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/monetary.test.ts [2m([22m[2m27 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/ai/mistral.extractor.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/queue/dead-letter-wiring.test.ts [2m([22m[2m4 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/format-readiness.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 9[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/database-helpers.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/errors.test.ts [2m([22m[2m14 tests[22m[2m)[22m[32m 7[2mms[22m[39m
[90mstdout[2m | tests/unit/lib/rate-limiter.test.ts
[22m[39m{"timestamp":"2026-02-19T09:32:29.330Z","level":"INFO","message":"Redis not configured, using in-memory rate limiter (development only)"}

[90mstderr[2m | tests/unit/lib/rate-limiter.test.ts[2m > [22m[2mRate Limiter[2m > [22m[2mcheckRateLimit[2m > [22m[2mshould block after limit exceeded
[22m[39m{"timestamp":"2026-02-19T09:32:29.346Z","level":"WARN","message":"Rate limit (memory): Too many attempts, blocking","data":{"identifier":"spam-test-id","preset":"login","attempts":6,"blockedForSeconds":900}}
{"timestamp":"2026-02-19T09:32:29.347Z","level":"WARN","message":"Rate limit (memory): Request blocked","data":{"identifier":"spam-test-id","blockedForSeconds":900}}

 [32mâœ“[39m tests/unit/lib/rate-limiter.test.ts [2m([22m[2m9 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/database.service.test.ts [2m([22m[2m21 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/extraction/extraction-prompt.contract.test.ts [2m([22m[2m11 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/facturx-profile-mapping-integration.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/cors.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/gemini.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/validators.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/validation/monetary-validator.net-gross.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/text-extraction.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/credits/credit-concurrency.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/invoice-review-payload.test.ts [2m([22m[2m12 tests[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/format-utils.test.ts [2m([22m[2m15 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/validation-error-propagation.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 5[2mms[22m[39m
 [32mâœ“[39m tests/unit/lib/extraction-retry.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 5[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m .agent/skills/scripts/tests/validate_skills_headings.test.js[2m [ .agent/skills/scripts/tests/validate_skills_headings.test.js ][22m
[31m[1mError[22m: No test suite found in file C:/Users/osama/Desktop/Invoice2E.1/.agent/skills/scripts/tests/validate_skills_headings.test.js[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/1]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m97 passed[39m[22m[90m (98)[39m
[2m      Tests [22m [1m[32m1492 passed[39m[22m[90m (1492)[39m
[2m   Start at [22m 10:32:04
[2m   Duration [22m 27.19s[2m (transform 10.97s, setup 27.45s, collect 31.16s, tests 3.32s, environment 239.24s, prepare 32.03s)[22m

