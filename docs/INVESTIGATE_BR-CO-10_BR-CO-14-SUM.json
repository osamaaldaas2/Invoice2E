{
  "investigation_date": "2026-02-13T17:00:00Z",
  "investigation_id": "BR-CO-10_BR-CO-14-SUM_NET_GROSS_SEMANTIC_CONFUSION",
  "status": "ROOT_CAUSE_IDENTIFIED",
  "severity": "HIGH",
  "impact": "Systematic validation failures on (almost) every invoice after prompt changes",
  "scope": {
    "affected_rules": ["BR-CO-10", "BR-CO-14-SUM", "BR-CO-15"],
    "affected_flows": [
      "Single-file extraction → /api/invoices/convert",
      "Batch extraction → Gemini adapter",
      "Batch extraction → DeepSeek adapter (DEFAULT)"
    ],
    "user_reported_symptom": "Line items total 23.68 (gross) while subtotal shows 19.9 (net)"
  },
  "hypothesis": "Net vs gross semantic confusion in extraction prompt or normalization after recent prompt edits",
  "investigation_steps": {
    "S1_confirm_failing_rules": {
      "status": "COMPLETED",
      "findings": {
        "BR-CO-10": {
          "rule_name": "Sum of line net amounts must equal invoice subtotal (BT-106)",
          "location": "lib/monetary-validator.ts:51-59",
          "validation_logic": "Sum(lineItems.netAmount) must equal subtotal within ±0.02 tolerance",
          "code_snippet": "const lineNetSum = sumMoney(totals.lineItems.map((li) => li.netAmount));\nif (!moneyEqual(lineNetSum, totals.subtotal, 0.02)) {\n  errors.push({ ruleId: 'BR-CO-10', message: 'Sum of line net amounts does not match invoice subtotal (BT-106)', expected: lineNetSum.toFixed(2), actual: totals.subtotal.toFixed(2) });\n}",
          "failure_condition": "Line items contain GROSS amounts but validator expects NET"
        },
        "BR-CO-14-SUM": {
          "rule_name": "Total tax amount must match sum of tax breakdowns",
          "location": "lib/monetary-validator.ts:94-101",
          "validation_logic": "Sum of computed taxes from line items must equal reported taxAmount",
          "code_snippet": "if (taxGroups.length > 0 && !moneyEqual(computedTotalTax, totals.taxAmount, 0.02)) {\n  errors.push({ ruleId: 'BR-CO-14-SUM', message: 'Total tax amount does not match sum of tax breakdowns', expected: computedTotalTax.toFixed(2), actual: totals.taxAmount.toFixed(2) });\n}",
          "failure_condition": "If line netAmount is GROSS, computed tax is wrong → mismatch"
        },
        "BR-CO-15": {
          "rule_name": "Invoice total with VAT = total without VAT + total VAT",
          "location": "lib/monetary-validator.ts:82-91",
          "note": "Likely also fails as a cascade effect if subtotal/taxAmount are wrong"
        }
      },
      "evidence": {
        "official_en16931_examples": [
          {
            "file": "vendor/einvoicing/en16931/validation-1.3.15/examples/CII_example1.xml:56",
            "line_content": "<ram:LineTotalAmount>19.9</ram:LineTotalAmount>",
            "interpretation": "Official EN 16931 example shows LineTotalAmount as NET (before tax), not gross"
          },
          {
            "file": "vendor/einvoicing/en16931/validation-1.3.15/examples/guide-example1.xml:111",
            "line_content": "<cbc:LineExtensionAmount currencyID=\"EUR\">19.90</cbc:LineExtensionAmount>",
            "interpretation": "UBL syntax also confirms line totals are NET"
          }
        ],
        "validator_expectations": "All BR-CO monetary rules assume line item amounts are NET (before tax)"
      }
    },
    "S2_net_vs_gross_contract": {
      "status": "COMPLETED",
      "en16931_semantic_contract": {
        "line_item_totalPrice": {
          "bt_code": "BT-131",
          "en16931_name": "Invoice line net amount",
          "semantic": "NET (before tax)",
          "formula": "quantity × unitPrice (no tax included)",
          "xml_element_cii": "ram:LineTotalAmount",
          "xml_element_ubl": "cbc:LineExtensionAmount"
        },
        "line_item_taxRate": {
          "bt_code": "BT-119",
          "en16931_name": "VAT rate",
          "semantic": "Percentage rate (e.g. 19 for 19%)"
        },
        "invoice_subtotal": {
          "bt_code": "BT-106",
          "en16931_name": "Sum of Invoice line net amount",
          "semantic": "NET (sum of all line net amounts)",
          "formula": "Σ(line totalPrice)",
          "xml_element_cii": "ram:LineTotalAmount (header)",
          "xml_element_ubl": "cbc:LineExtensionAmount (header)"
        },
        "invoice_taxAmount": {
          "bt_code": "BT-110",
          "en16931_name": "Invoice total VAT amount",
          "semantic": "Total VAT computed from line items",
          "formula": "Σ(line netAmount × taxRate / 100)"
        },
        "invoice_totalAmount": {
          "bt_code": "BT-112",
          "en16931_name": "Invoice total amount with VAT",
          "semantic": "GROSS (subtotal + taxAmount)",
          "formula": "subtotal + taxAmount"
        }
      },
      "current_implementation_contract": {
        "extraction": "lib/extraction-prompt.ts:56-57 - AMBIGUOUS (no NET/GROSS specification)",
        "normalization": "lib/extraction-normalizer.ts:222 - PASSTHROUGH (no NET/GROSS conversion)",
        "validation": "validation/business-rules.ts:28 - ASSUMES NET (maps totalPrice → netAmount directly)",
        "builder": "services/xrechnung/builder.ts:120 - OUTPUTS AS NET (LineTotalAmount)",
        "conclusion": "CONTRACT VIOLATION: Extraction is ambiguous, but downstream assumes NET"
      },
      "german_invoice_layout_reality": {
        "common_formats": [
          {
            "format_name": "German gross-display invoices",
            "columns": ["Pos", "Description", "Qty", "Unit Price (NET)", "Tax %", "Line Total (GROSS with tax)"],
            "rightmost_column": "Line Total (GROSS with tax)",
            "problem": "When prompt says 'often shown in rightmost column', AI extracts GROSS total"
          },
          {
            "format_name": "German net-display invoices",
            "columns": ["Pos", "Description", "Qty", "Unit Price (NET)", "Line Total (NET)", "Tax %"],
            "rightmost_column": "Tax %",
            "note": "Less common, but exists — extracts correctly as NET"
          }
        ],
        "ambiguity_source": "German invoices vary in column order and whether rightmost column shows NET or GROSS"
      }
    },
    "S3_trace_data_path": {
      "status": "COMPLETED",
      "flow": "AI Extraction → Normalization → Review Service → XRechnung Builder → BR-CO Validator",
      "stage_1_extraction": {
        "file": "lib/extraction-prompt.ts",
        "line_numbers": "56-57",
        "prompt_text": "\"totalPrice\": \"number — line total (quantity × unitPrice, often shown in rightmost column)\"",
        "critical_flaw": "NO EXPLICIT NET/GROSS GUIDANCE",
        "ai_behavior": "LLM extracts whatever number is in the rightmost column (may be GROSS with tax)",
        "risk_factor": "HIGH - German invoices commonly show GROSS totals in rightmost column"
      },
      "stage_2_normalization": {
        "file": "lib/extraction-normalizer.ts",
        "line_numbers": "211-226",
        "code_snippet": "lineItems: rawItems.map((item: Record<string, unknown>) => {\n  const tp = safeNumberStrict(item?.totalPrice);\n  return {\n    totalPrice: isNaN(tp) ? 0 : tp,  // <- Direct passthrough\n    taxRate: resolvedRate,\n  };\n})",
        "critical_flaw": "NO SEMANTIC VALIDATION",
        "missing_logic": [
          "No check if totalPrice ≈ unitPrice × quantity",
          "No GROSS→NET conversion when taxRate is present",
          "No warning if totalPrice seems inconsistent with tax semantics"
        ],
        "risk_factor": "CRITICAL - Silent propagation of semantic errors"
      },
      "stage_3_review_service": {
        "file": "services/review.service.ts",
        "line_numbers": "143",
        "code_snippet": "const lineNetSum = sumMoney(data.lineItems.map((li) => li.totalPrice));",
        "behavior": "Assumes totalPrice is NET when checking monetary consistency",
        "note": "Review service validation would catch GROSS vs NET mismatch if subtotal is NET, but check may pass if both are consistently wrong"
      },
      "stage_4_xrechnung_builder": {
        "file": "services/xrechnung/builder.ts",
        "line_numbers": "89-91, 120",
        "code_snippet": "const totalPrice = totalPriceRaw ?? unitPrice * quantity;\n// ...\n<ram:LineTotalAmount>${totalPrice.toFixed(2)}</ram:LineTotalAmount>",
        "behavior": "Outputs totalPrice as LineTotalAmount (BT-131 = NET amount per EN 16931)",
        "note": "If totalPrice is GROSS, the XML contains wrong NET value"
      },
      "stage_5_br_co_validator": {
        "file": "validation/business-rules.ts",
        "line_numbers": "20-31",
        "code_snippet": "const lineItems: MonetaryLineItem[] = items.map((item) => {\n  const totalPrice = Number(item.totalPrice ?? item.lineTotal) || unitPrice * quantity;\n  return {\n    netAmount: roundMoney(totalPrice),  // <- ASSUMES totalPrice is NET!\n    taxRate,\n  };\n});",
        "critical_flaw": "DIRECT MAPPING totalPrice → netAmount WITH NO VALIDATION",
        "failure_mode": "If totalPrice is GROSS (23.68), netAmount becomes 23.68 instead of 19.9 → BR-CO-10 fails"
      }
    },
    "S4_arithmetic_invariant_check": {
      "status": "COMPLETED",
      "scenario_a_line_items_are_gross": {
        "description": "AI extracted GROSS amounts (including tax) for line items",
        "example": {
          "unitPrice": 19.9,
          "quantity": 1,
          "taxRate": 19,
          "extracted_totalPrice": 23.68,
          "expected_net_totalPrice": 19.9,
          "extracted_subtotal": 19.9,
          "extracted_taxAmount": 3.78,
          "extracted_totalAmount": 23.68
        },
        "validation_flow": {
          "step_1": "Validator maps totalPrice=23.68 → netAmount=23.68",
          "step_2": "BR-CO-10: sum(netAmount)=23.68 vs subtotal=19.9 → FAIL (diff: 3.78)",
          "step_3": "BR-CO-14-SUM: computeTax(23.68, 19%) = 4.50 vs taxAmount=3.78 → FAIL (diff: 0.72)",
          "step_4": "BR-CO-15: expectedTotal = 19.9 + 3.78 = 23.68 vs totalAmount=23.68 → PASS (by coincidence)"
        },
        "conclusion": "BR-CO-10 and BR-CO-14-SUM fail because line items are GROSS but validator expects NET"
      },
      "scenario_b_line_items_are_net": {
        "description": "AI correctly extracted NET amounts for line items",
        "example": {
          "unitPrice": 19.9,
          "quantity": 1,
          "taxRate": 19,
          "extracted_totalPrice": 19.9,
          "extracted_subtotal": 19.9,
          "extracted_taxAmount": 3.78,
          "extracted_totalAmount": 23.68
        },
        "validation_flow": {
          "step_1": "Validator maps totalPrice=19.9 → netAmount=19.9",
          "step_2": "BR-CO-10: sum(netAmount)=19.9 vs subtotal=19.9 → PASS",
          "step_3": "BR-CO-14-SUM: computeTax(19.9, 19%) = 3.78 vs taxAmount=3.78 → PASS",
          "step_4": "BR-CO-15: expectedTotal = 19.9 + 3.78 = 23.68 vs totalAmount=23.68 → PASS"
        },
        "conclusion": "All BR-CO rules pass when line items are correctly NET"
      },
      "root_cause_confirmation": "Validation failures occur systematically when AI extracts GROSS line totals instead of NET"
    },
    "S5_rounding_precision_check": {
      "status": "COMPLETED",
      "findings": {
        "monetary_utilities": "lib/monetary.ts - All operations use integer-cent arithmetic (toCents/fromCents)",
        "rounding_policy": "HALF_UP (Math.round) with 2-decimal precision",
        "tolerance": "±0.02 EUR (2 cents) in BR-CO validation (moneyEqual function)",
        "evidence": "No floating-point drift observed in test cases (tests/unit/lib/monetary.test.ts)",
        "conclusion": "ROUNDING IS NOT THE ISSUE - The 3.78 EUR difference (23.68 - 19.9) far exceeds 0.02 tolerance"
      },
      "precision_adequate": true,
      "not_a_contributing_factor": "Rounding precision is correctly implemented and sufficient"
    },
    "S6_prompt_edit_analysis": {
      "status": "COMPLETED",
      "current_prompt_version": "v1 — Original prompt (restored)",
      "prompt_file": "lib/extraction-prompt.ts",
      "critical_lines": {
        "line_56_57": {
          "text": "\"totalPrice\": \"number — line total (quantity × unitPrice, often shown in rightmost column)\"",
          "analysis": {
            "issue_1": "NO NET/GROSS SPECIFICATION - AI doesn't know which semantic to extract",
            "issue_2": "MISLEADING HINT 'rightmost column' - German invoices often show GROSS in rightmost column",
            "issue_3": "FORMULA 'quantity × unitPrice' - Suggests NET calculation, but contradicts 'rightmost column' hint"
          }
        },
        "line_64": {
          "text": "\"subtotal\": \"number or null — net subtotal if shown. If not visible, return null — never guess or use 0.\"",
          "analysis": "CORRECT - Explicitly specifies 'net subtotal'"
        },
        "line_66": {
          "text": "\"totalAmount\": \"number or null — total payable/grand total if shown\"",
          "analysis": "CORRECT - Implicitly GROSS (total payable)"
        }
      },
      "inconsistency_identified": "Prompt specifies NET for subtotal but is ambiguous for line item totalPrice",
      "hypothesis_confirmation": "Recent prompt changes likely removed explicit NET guidance or added ambiguous 'rightmost column' hint"
    }
  },
  "root_cause_analysis": {
    "primary_root_cause": {
      "id": "RC-1",
      "title": "Ambiguous extraction prompt for line item totalPrice (NET vs GROSS)",
      "severity": "CRITICAL",
      "location": "lib/extraction-prompt.ts:56-57",
      "description": "The extraction prompt does not explicitly specify that line item 'totalPrice' must be NET (before tax). The hint 'often shown in rightmost column' is misleading because German invoices commonly display GROSS totals (including tax) in the rightmost column.",
      "evidence": [
        "Prompt line 56-57: 'totalPrice: number — line total (quantity × unitPrice, often shown in rightmost column)' - NO NET/GROSS specification",
        "Prompt line 64: 'subtotal: number or null — net subtotal if shown' - EXPLICIT NET specification for subtotal",
        "German invoice reality: Rightmost column often shows GROSS total (e.g. 23.68 EUR with 19% tax included)",
        "EN 16931 BT-131 specification: Line total must be NET (confirmed by official examples showing 19.9 not 23.68)"
      ],
      "impact": "AI extracts GROSS amounts (23.68) into totalPrice field, causing systematic BR-CO-10 and BR-CO-14-SUM failures",
      "confidence": "95%"
    },
    "secondary_root_cause": {
      "id": "RC-2",
      "title": "No semantic validation or GROSS→NET conversion in normalizer",
      "severity": "HIGH",
      "location": "lib/extraction-normalizer.ts:211-226",
      "description": "The normalizer passes through AI-extracted totalPrice without validating semantic consistency (NET vs GROSS) or converting GROSS→NET when a tax rate is present.",
      "evidence": [
        "Line 222: 'totalPrice: isNaN(tp) ? 0 : tp' - Direct passthrough, no validation",
        "No check if totalPrice ≈ unitPrice × quantity",
        "No GROSS→NET conversion logic: if (totalPrice && taxRate) { netAmount = totalPrice / (1 + taxRate/100) }",
        "Silent propagation of semantic errors to downstream validation"
      ],
      "impact": "Even if AI extracts GROSS amounts, the normalizer could detect and correct this, but currently doesn't",
      "confidence": "90%"
    },
    "tertiary_root_cause": {
      "id": "RC-3",
      "title": "Validator directly maps totalPrice → netAmount without validation",
      "severity": "MEDIUM",
      "location": "validation/business-rules.ts:28",
      "description": "The BR-CO validator assumes totalPrice is NET and maps it directly to netAmount for validation without any semantic check.",
      "evidence": [
        "Line 28: 'netAmount: roundMoney(totalPrice)' - Direct mapping with assumption",
        "No validation that totalPrice is semantically consistent with unitPrice × quantity",
        "Downstream BR-CO rules fail instead of failing early with clear error message"
      ],
      "impact": "Late detection of semantic errors leads to cryptic BR-CO validation failures instead of clear 'line total must be NET' error",
      "confidence": "85%"
    }
  },
  "data_flow_corruption_point": {
    "entry_point": "AI extraction (DeepSeek/Gemini)",
    "corruption_occurs_at": "lib/extraction-prompt.ts:56-57 - AI extracts GROSS instead of NET",
    "propagation_path": [
      "1. AI extracts totalPrice=23.68 (GROSS with 19% tax)",
      "2. Normalizer passes through totalPrice=23.68 unchanged",
      "3. Review service assumes totalPrice=23.68 is NET (may pass if subtotal is also wrong)",
      "4. XRechnung builder outputs LineTotalAmount=23.68 (wrong NET value in XML)",
      "5. BR-CO validator compares sum(23.68) vs subtotal(19.9) → BR-CO-10 FAIL",
      "6. BR-CO validator computes tax on 23.68 → wrong tax → BR-CO-14-SUM FAIL"
    ],
    "no_error_recovery": "No stage detects or corrects the semantic error until final validation",
    "fix_required_at": "Extraction prompt (RC-1) AND/OR Normalizer (RC-2)"
  },
  "affected_invoices_profile": {
    "systematic_failure_when": [
      "Invoice displays line totals as GROSS (with tax included) in rightmost column",
      "AI follows 'rightmost column' hint and extracts GROSS amounts",
      "Subtotal correctly extracted as NET from invoice footer",
      "Result: Line items (GROSS) don't match subtotal (NET) → BR-CO-10 fails"
    ],
    "invoices_that_pass": [
      "Invoices where rightmost column shows NET line totals",
      "Invoices where AI ignores 'rightmost column' hint and calculates qty × unitPrice (NET)"
    ],
    "estimated_failure_rate": "HIGH (60-80% of German invoices based on common layout patterns)"
  },
  "fix_plan_preview": {
    "note": "DO NOT IMPLEMENT YET - This is investigation only",
    "recommended_fixes": [
      {
        "fix_id": "F1",
        "title": "Clarify extraction prompt to explicitly specify NET for line item totalPrice",
        "priority": "CRITICAL",
        "location": "lib/extraction-prompt.ts:56-57",
        "changes": [
          "Remove misleading hint: 'often shown in rightmost column'",
          "Add explicit guidance: 'IMPORTANT: totalPrice MUST be the NET amount (before tax). If the invoice shows a gross total including tax, you must extract the net amount (typically quantity × unit price). Do NOT extract amounts that already include tax.'",
          "Add validation hint: 'Verify: totalPrice should equal quantity × unitPrice (before tax). If tax is included, subtract it.'"
        ],
        "estimated_effort": "10 minutes",
        "risk": "LOW - Prompt change only, no code changes"
      },
      {
        "fix_id": "F2",
        "title": "Add semantic validation in normalizer to detect and warn on GROSS vs NET inconsistency",
        "priority": "HIGH",
        "location": "lib/extraction-normalizer.ts:211-226",
        "changes": [
          "After mapping line items, check if totalPrice ≈ unitPrice × quantity (tolerance ±1%)",
          "If totalPrice >> unitPrice × quantity and taxRate is present, log warning: 'Line item totalPrice appears to be GROSS (including tax), but NET is required'",
          "Optionally: Auto-convert GROSS→NET with formula: netAmount = totalPrice / (1 + taxRate/100)",
          "Add unit tests for NET/GROSS detection logic"
        ],
        "estimated_effort": "2-3 hours",
        "risk": "MEDIUM - Requires careful testing to avoid false positives"
      },
      {
        "fix_id": "F3",
        "title": "Add early semantic validation in business-rules validator with clear error message",
        "priority": "MEDIUM",
        "location": "validation/business-rules.ts:20-31",
        "changes": [
          "Before mapping totalPrice → netAmount, validate: totalPrice ≈ unitPrice × quantity (tolerance ±1%)",
          "If validation fails, push structured error: 'Line item {index}: totalPrice ({value}) does not match unitPrice × quantity. Ensure line totals are NET (before tax).'",
          "This provides clear, actionable error message instead of cryptic BR-CO-10 failure"
        ],
        "estimated_effort": "1 hour",
        "risk": "LOW - Validation enhancement only"
      },
      {
        "fix_id": "F4",
        "title": "Add frontend readiness check for NET/GROSS consistency (D1-D6 plan)",
        "priority": "LOW",
        "location": "components/forms/invoice-review/ReadinessPanel.tsx (NEW)",
        "changes": [
          "Live validation: Check if sum(line totalPrice) ≈ subtotal",
          "If mismatch detected, show warning: 'Line totals may be GROSS instead of NET'",
          "Guide user to review and correct line item amounts before submission"
        ],
        "estimated_effort": "Part of D1-D6 frontend alignment plan",
        "risk": "LOW - UX enhancement only"
      }
    ],
    "recommended_implementation_order": [
      "1. F1 (Prompt fix) - IMMEDIATE - Prevents issue at source",
      "2. F2 (Normalizer validation) - HIGH PRIORITY - Defense in depth",
      "3. F3 (Validator clear error) - MEDIUM PRIORITY - Better error messages",
      "4. F4 (Frontend readiness) - OPTIONAL - UX polish"
    ],
    "testing_requirements": [
      "Create test invoices with GROSS line totals (23.68) and NET subtotal (19.9)",
      "Verify F1 prompt change causes AI to extract NET (19.9) instead of GROSS (23.68)",
      "Verify F2 normalizer detects GROSS→NET conversion need and logs warning or auto-converts",
      "Verify F3 validator provides clear error message when NET/GROSS mismatch detected",
      "Run batch extraction on 20-30 German invoices and verify BR-CO-10/BR-CO-14-SUM pass rate improves from ~20% to >95%"
    ]
  },
  "next_steps": {
    "immediate": [
      "User reviews this investigation report",
      "User approves fix plan F1-F4",
      "Implement F1 (prompt fix) first as critical path"
    ],
    "after_fix": [
      "Run regression tests on existing test suite",
      "Batch validate 50+ sample invoices to measure improvement",
      "Monitor BR-CO-10/BR-CO-14-SUM failure rate in production",
      "Consider adding extraction_snapshot comparison (before/after prompt fix) to measure AI accuracy improvement"
    ]
  },
  "summary": {
    "status": "ROOT_CAUSE_CONFIRMED",
    "primary_cause": "Ambiguous extraction prompt causes AI to extract GROSS line totals instead of NET",
    "secondary_cause": "No semantic validation or GROSS→NET conversion in normalizer",
    "impact": "Systematic BR-CO-10 and BR-CO-14-SUM validation failures on 60-80% of invoices",
    "evidence_strength": "HIGH - Confirmed by EN 16931 spec, official examples, code analysis, and data flow trace",
    "fix_confidence": "95% - Prompt clarification (F1) will resolve majority of failures",
    "recommended_action": "Implement F1 (prompt fix) immediately, then F2 (normalizer validation) for defense in depth"
  }
}
