before i start this prompt, i had forgot to send you the last POST-FIX MULTI-FORMAT SYSTEM AUDIT REPORT: 
Section A — GO / NO-GO
CONDITIONAL NO-GO — 3 BLOCKERs, 4 CRITICALs remain
BLOCKERs (must-fix before any production traffic):

#	Finding	Impact
B-01	structuredErrors access on ValidationError is broken — convert route returns empty validationErrors: [] and never logs ruleIds	Users see "Validation failed" with zero actionable errors. F-08 ruleId logging is dead code.
B-02	Factur-X rules are dead code — formatToProfileId routes both Factur-X profiles to 'en16931-base' (returns []) instead of their actual validators	Factur-X invoices skip ALL profile-specific validation. Corrupt XML silently generated.
B-03	ReadinessPanel is 100% XRechnung-hardcoded — shows "Not Ready" for valid FatturaPA/KSeF/PEPPOL invoices missing IBAN	False negative UX: valid non-XRechnung invoices appear broken.
Section B — Findings Table
ID	Severity	Category	File(s)	Function/Component	Root Cause	Impact	Failure Scenario	Minimal Fix
B-01	BLOCKER	Observability Gap	convert/route.ts:203	catch(generationError)	Accesses generationError.structuredErrors but ValidationError stores data in .details.structuredErrors. Cast produces undefined.	validationErrors: [] always sent to UI. F-08 ruleId logging block never executes.	User converts invalid invoice → sees "Validation failed: [BR-DE-23-a] ..." in error text but zero structured error badges. Cannot identify which field to fix.	Change line 203 to: const structuredErrors = (generationError as ValidationError).details?.structuredErrors;
B-02	BLOCKER	Validation Pipeline Mismatch	format-utils.ts:10-11, ProfileValidatorFactory.ts:58-77	formatToProfileId()	Maps facturx-en16931 and facturx-basic → 'en16931-base' (empty validator), bypassing FacturXEN16931ProfileValidator and FacturXBasicProfileValidator which exist and call validateFacturXRules().	Factur-X pre-generation validation runs zero profile rules. Missing seller address, country code, tax ID pass silently.	User submits Factur-X invoice with empty seller address → passes convert pre-validation → generator produces incomplete XML.	Change mapping: 'facturx-en16931' → 'facturx-en16931', 'facturx-basic' → 'facturx-basic'
B-03	BLOCKER	Hardcoding / Compliance Masking	ReadinessPanel.tsx:69-91	ReadinessPanel	All 14 error-level checks are XRechnung-specific (IBAN, seller phone, payment terms). Panel ignores selected outputFormat.	FatturaPA/KSeF users see "Not Ready" for valid invoices. XRechnung users see "Ready" despite missing seller tax ID.	User selects KSeF → fills all KSeF-required fields → panel shows 3/14 errors (IBAN, phone, email) → user thinks invoice is broken.	Pass outputFormat to panel, make checks conditional per format.
B-04	CRITICAL	Context Loss	convert/page.tsx:61, review/route.ts:147-155	handleConvert DB fallback	outputFormat stored in conversions table only, not in extractionData. DB fallback reads extractionData → invoiceData.outputFormat is undefined → defaults to 'xrechnung-cii'.	User refreshes convert page (or opens in new tab) → silently converts to wrong format.	User reviews FatturaPA invoice → closes tab → returns via bookmark → page converts as XRechnung-CII.	Store outputFormat in extractionData during review, OR fetch conversion record in fallback.
B-05	CRITICAL	Warning Semantics Defect	review/route.ts:143-155, extractions/route.ts:42-43	normalizeForPersistence + _originalExtraction stripping	validationWarnings from AI extraction are in extractionData pre-review. After review save, they end up inside _originalExtraction (which is stripped from API responses). persistData (the cleaned reviewed data) never had them.	After page refresh, review form shows no warnings even if AI had math errors. DB fallback also loses warnings.	User sees extraction warnings → refreshes page → warnings vanish → submits invoice believing data is clean.	Copy validationWarnings from original extraction into persistData during review save.
B-06	CRITICAL	Validation Pipeline Mismatch	review.service.ts, all non-XRechnung formats	validateReviewedData()	No tax ID validation at review stage for any format. FatturaPA requires seller VAT ID (FPA-010), KSeF requires 10-digit NIP (KSEF-01), PEPPOL requires at least one tax ID (R004).	Invoices pass review → fail at convert with cryptic rule IDs.	User submits FatturaPA without seller VAT ID → review passes → convert fails with FPA-010.	Add tax ID presence check at review stage, conditional per format.
B-07	CRITICAL	Hardcoding / Compliance Masking	fatturapa.generator.ts:156, fatturapa.generator.ts:172	FatturaPA generator	CodiceDestinatario defaults to '0000000' (uses buyer email field, not 7-char SDI code). RegimeFiscale defaults to 'RF01'. No form field collects either value.	B2B FatturaPA invoices won't route to buyer's SDI inbox. Wrong tax regime for non-ordinary businesses.	Italian B2B user generates FatturaPA → invoice has 0000000 routing code → SDI cannot deliver to buyer → invoice rejected.	Add buyerSdiCode and sellerTaxRegime fields to form when FatturaPA is selected.
B-08	HIGH	Observability Gap	logger.ts:44-47, all API routes	logContext	logContext.run() is exported but never called by any API route. Middleware sets x-request-id header but no route reads it. All log entries have requestId: undefined.	F-08 request tracing is fully wired but not connected. Cannot correlate logs across a single request.	Operator tries to debug a failed conversion → searches logs by requestId → finds nothing.	Create a wrapper withRequestId(handler) and apply to critical routes (convert, review, extract).
B-09	HIGH	Fallback Data Integrity Defect	CreditHistory.tsx:22-23, CreditHistory.tsx:48-54	getSourceDisplay	extraction:deduct and extraction:deduct:multi don't match any SOURCE_KEYS entry or fallback prefix. batch:refund:* matches startsWith('batch:') before includes('refund:'), showing as "batchExtraction" not "refund".	Credit history shows raw strings for deductions and wrong icons for batch refunds.	User checks credit history → sees extraction:deduct instead of "Invoice Extraction" → confused.	Update SOURCE_KEYS to include new reason strings; reorder fallback checks (refund before batch).
B-10	HIGH	Hardcoding / Compliance Masking	InvoiceReviewForm.tsx:23-32	COUNTRY_CODES	Only 8 countries listed (DE, AT, CH, FR, IT, ES, NL, BE). Missing PL (KSeF), RO (CIUS-RO), and all other EU countries.	Polish/Romanian users cannot set their country code via dropdown.	User selects KSeF → tries to set country to PL → not in dropdown → must type manually (if even possible with select).	Expand country list to all EU member states, or use a searchable input.
B-11	MEDIUM	Hardcoding / Compliance Masking	PaymentSection.tsx (entire file)	PaymentSection	paymentDueDate field exists in form state (useInvoiceReviewForm.ts:44) and is used by canonical mapper, but PaymentSection never renders an input for it.	Due date is only populated if AI extracted it. Users cannot add/edit due date. XRechnung BR-CO-25 requires payment terms or due date.	AI fails to extract due date → user cannot add one → if payment terms also empty → convert fails with BR-CO-25.	Add <input {...register('paymentDueDate')} /> to PaymentSection.
B-12	MEDIUM	Arithmetic Reconciliation Defect	extraction-validator.ts:92-111	validateExtraction — tax check	All-zero-rate invoice: itemsWithRates is empty (filter requires taxRate > 0), fallback requires data.taxRate > 0. So zero-rate invoices skip tax validation entirely — a non-zero taxAmount passes silently.	AI extracts wrong taxAmount on a zero-rate invoice → no validation error → no retry → bad data persisted.	Zero-rated export invoice with AI-hallucinated taxAmount of €500 → passes validation → stored as correct.	Handle taxRate === 0 items: sum their expected tax (0), include in check.
B-13	MEDIUM	Arithmetic Reconciliation Defect	extraction-validator.ts:103	validateExtraction — tolerance scaling	scaledTolerance = tol.TAX * itemsWithRates.length → for 100 line items, tolerance = €5.00.	Large invoices can have €4.99 tax error undetected.	100-item invoice with €4.50 tax calculation error → passes validation → user trusts incorrect totals.	Cap scaled tolerance at Math.min(scaledTolerance, 1.0) or use sqrt scaling.
B-14	LOW	Warning Semantics Defect	useInvoiceReviewForm.ts:261	onSubmit payload	Spreads ...data (includes items array) alongside explicit lineItems mapping. ReviewedDataSchema.passthrough() preserves both.	Double line-item data stored in DB JSONB, wasting storage.	Not user-facing; performance/storage impact only.	Destructure items out of data before spread: const { items, ...rest } = data.
Section C — Evidence Pack
BLOCKER B-01: structuredErrors is always undefined
Root cause chain:

lib/errors.ts:13-16: ValidationError calls super('VALIDATION_ERROR', message, 400, details) → stores in this.details
convert/route.ts:115-118: throw new ValidationError('...', { structuredErrors: preValidation.errors }) → this.details = { structuredErrors: [...] }
convert/route.ts:203: (generationError as ValidationError & { structuredErrors?: ... }).structuredErrors → accesses .structuredErrors on the error object directly, NOT .details.structuredErrors → undefined
Reproduction:

Submit an invoice missing seller IBAN → review passes
Click "Convert" → convert route runs validateForProfile → BR-DE-23-a fires
Response body: { success: false, error: "Validation failed: [BR-DE-23-a] ...", validationErrors: [] }
UI shows error text but zero ruleId badges in the structured errors list
Log pattern: The logger.warn('Validation rule failures', ...) on line 209 never fires because Array.isArray(undefined) is false.

BLOCKER B-02: Factur-X rules are dead code
Root cause chain:

format-utils.ts:10-11: formatToProfileId('facturx-en16931') returns 'en16931-base', same for 'facturx-basic'
ProfileValidatorFactory.ts:94-102: EN16931BaseProfileValidator.validate() returns []
ProfileValidatorFactory.ts:58-77: FacturXEN16931ProfileValidator and FacturXBasicProfileValidator exist and call validateFacturXRules() — but are never instantiated because getProfileValidator('en16931-base') hits the base class
Reproduction:

Select Factur-X EN16931 format → submit review with empty seller address, empty country codes, empty tax ID
Click Convert → validateForProfile(canonical, 'en16931-base') runs
Stage 4 returns [] → pre-validation passes
Generator produces XML with missing required fields
BLOCKER B-03: ReadinessPanel hardcoded for XRechnung
Evidence: ReadinessPanel.tsx:69-91 — the checks array is a static list. No parameter for outputFormat in ReadinessPanelProps (line 9-11). No conditional logic based on format.

Reproduction:

Select KSeF format in FormatSelector
Fill all fields required by KSeF (invoice number, date, seller/buyer name, seller NIP, line items with Polish tax rates)
Leave IBAN, seller email, seller phone, payment terms empty (not required by KSeF)
Panel shows 10/14 checks passed, "Not Ready" in red
User adds fake IBAN and email just to satisfy the panel → converts → these values are irrelevant to KSeF
Section D — Minimal Fix Plan (Staged)
P0: Must-Fix for Correctness & Safety
P0-1: Fix structuredErrors access (B-01)

File: convert/route.ts:203
Change: (generationError as ValidationError).details?.structuredErrors
Also fixes: F-08 ruleId logging and frontend error badge rendering
Tests: existing convert route tests + add test for structured error propagation
P0-2: Fix Factur-X profile mapping (B-02)

File: format-utils.ts:10-11
Change: 'facturx-en16931' → 'facturx-en16931', 'facturx-basic' → 'facturx-basic'
Impact: Factur-X rules now fire during pre-validation, may surface new errors for existing test fixtures
Tests: update golden file tests if needed; add Factur-X validation test cases
P0-3: Preserve outputFormat in DB fallback path (B-04)

File: review/route.ts — add outputFormat to persistData
Impact: DB fallback recovers correct format
Tests: add unit test for review route outputFormat persistence
P0-4: Preserve validationWarnings across review save (B-05)

File: review/route.ts — copy extractionData.validationWarnings into persistData
Impact: warnings survive page refresh
Tests: add unit test verifying warnings in persisted data
P1: Must-Fix for Compliance
P1-1: Make ReadinessPanel format-aware (B-03)

File: ReadinessPanel.tsx
Change: Accept outputFormat prop, make IBAN/phone/email/paymentTerms checks conditional per format
Define per-format check sets (XRechnung: all 14; KSeF: invoice#, date, seller, buyer, lineItems, monetary; etc.)
P1-2: Add tax ID review validation per format (B-06)

File: review.service.ts
Add: FatturaPA → require sellerVatId or sellerTaxId; KSeF → require NIP-like tax ID; PEPPOL/NLCIUS/CIUS-RO → require at least one of vatId/taxNumber/taxId
P1-3: Fix FatturaPA compliance defaults (B-07)

Files: form components + fatturapa.generator.ts
Add: buyerSdiCode field (visible when FatturaPA selected), sellerTaxRegime dropdown (RF01-RF19)
P1-4: Expand country code list (B-10)

File: InvoiceReviewForm.tsx:23-32
Add: PL, RO, PT, SE, DK, FI, IE, LU, CZ, SK, HU, BG, HR, SI, LT, LV, EE, CY, MT, GR, EL
P1-5: Add paymentDueDate input to PaymentSection (B-11)

File: PaymentSection.tsx
Add: <input type="date" {...register('paymentDueDate')} />
P2: Improvements & Refactors
P2-1: Connect logContext.run() in API routes (B-08)

Create lib/with-request-id.ts wrapper
Apply to convert, review, extract routes
P2-2: Fix credit history source key mapping (B-09)

File: CreditHistory.tsx
Add 'extraction:deduct', 'extraction:deduct:multi' to SOURCE_KEYS
Reorder fallback: check includes('refund') before startsWith('batch:')
P2-3: Cap tax tolerance scaling (B-13)

File: extraction-validator.ts:103
Change: Math.min(tol.TAX * Math.max(1, itemsWithRates.length), 1.0)
P2-4: Handle zero-rate tax validation (B-12)

File: extraction-validator.ts:92-94
Change: Include items with taxRate === 0 in itemsWithRates filter, or add dedicated zero-rate check
P2-5: Remove duplicate items array in review payload (B-14)

File: useInvoiceReviewForm.ts:261
Change: const { items: _items, ...rest } = data; const payload = { ...rest, lineItems: ... }
Verification Gates Status
All four gates currently pass (as of the prior implementation):

tsc --noEmit — 0 errors
vitest run — 1065/1065 tests pass
npm run build — exit code 0
npm run lint — 0 errors, 78 pre-existing warnings
The findings above are runtime behavioral defects that pass compilation/testing because:

B-01: No test exercises the catch path with a real ValidationError and checks validationErrors response body
B-02: No test calls formatToProfileId('facturx-en16931') and asserts the result is 'facturx-en16931'
B-03: ReadinessPanel has no tests at all (client component, not in vitest suite)
